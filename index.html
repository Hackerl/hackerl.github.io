<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hello World</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hello World">
<meta property="og:url" content="https://hackerl.github.io/index.html">
<meta property="og:site_name" content="Hello World">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="hackerl">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hello World" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.1.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hello World</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://hackerl.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-CPP-协程踩坑" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/11/02/CPP-%E5%8D%8F%E7%A8%8B%E8%B8%A9%E5%9D%91/" class="article-date">
  <time datetime="2023-11-02T08:18:33.000Z" itemprop="datePublished">2023-11-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/11/02/CPP-%E5%8D%8F%E7%A8%8B%E8%B8%A9%E5%9D%91/">C++ 协程踩坑</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="按值传递"><a href="#按值传递" class="headerlink" title="按值传递"></a>按值传递</h2><p>如果之前写惯了同步代码，那么函数参数写成 <code>const reference</code> 应该是肌肉记忆了，但是在写协程的入参时，你需要确切地知道自己在做什么。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Task&lt;<span class="keyword">int</span>&gt; <span class="title">func</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">co_await</span> xxxx;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; name &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">co_await</span> <span class="title">func</span><span class="params">(<span class="string">&quot;hello&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这段代码乍一看没什么问题，但是仔细一想协程可能会在 <code>co_await</code> 时将控制返回上层，那么 <code>std::string</code> 的临时变量还存在吗？对于上面的代码是存在的，因为 <code>co_await func(&quot;hello&quot;)</code> 这一行代码，在 <code>co_await</code> 等待完成之前，<code>hello</code> 的临时变量会保持存活，等到协程完成后才会被清理，但是如果改成下面这样：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> task = func(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">co_await</span> task;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样的写法应该是被允许的，因为生成 <code>task</code> 和等待 <code>task</code> 应该被允许分离，但是你会发现在执行 <code>co_await task</code> 时，<code>hello</code> 隐式转换的 <code>string</code> 已经结束了生命周期，但是 <code>task</code> 还没完成，在将来某一刻它还要访问变量 <code>name</code>。<br>如果可以保证 <code>const reference</code> 的入参只会在第一个等待点前访问，前提是协程是创建即执行的，那么也不会有任何问题。但是后续开发者改动代码产生问题的风险变增大了，他们必须时刻注意这一点，这应该是很难的。在性能和安全性之前我纠结了许久，最后还是建议协程的入参一般都应该传值。</p>
<h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><p>看看下面这段代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Task&lt;<span class="keyword">size_t</span>&gt; <span class="title">read</span><span class="params">(<span class="keyword">int</span> fd, <span class="built_in">std</span>::span&lt;<span class="built_in">std</span>::byte&gt; data)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::byte data[<span class="number">1024</span>];</span><br><span class="line">    <span class="function"><span class="keyword">co_await</span> <span class="title">read</span><span class="params">(<span class="number">1</span>, data)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>视图不持有对象，它可以被看成封装后的 <code>(void *, size_t)</code>，你可以说这里是按值传递了视图，但是并没有按值传递 <code>container</code>。不过这样的传递是没问题的，因为这类接口的目的就是读取完成后访问 <code>data</code>，那么反之可以确定数据在读取操作后还存在，应该不会有人这样写：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Task&lt;<span class="keyword">size_t</span>&gt; task;</span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">std</span>::byte data[<span class="number">1024</span>];</span><br><span class="line">        task = read(<span class="number">1</span>, data);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">co_await</span> task;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这种写法可能就是为了犯错而犯错，再来看另一个例子：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Task&lt;Socket&gt; <span class="title">connect</span><span class="params">(<span class="built_in">std</span>::span&lt;<span class="keyword">const</span> Address&gt; addresses)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> addresses = &#123;...&#125;;</span><br><span class="line">    <span class="function"><span class="keyword">co_await</span> <span class="title">connect</span><span class="params">(addresses)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码允许连接一系列目标地址直到连接成功，那么上层代码可能关心的只是返回的 <code>Socket</code>，那么可能有小概率出现下面这样错误的写法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Task&lt;Socket&gt; task;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> addresses = &#123;...&#125;;</span><br><span class="line">        task = connect(addresses);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">co_await</span> task;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外值得一提的是，还有一种常见的错误：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> &amp;addresses = <span class="keyword">co_await</span> dns::query(<span class="string">&quot;domain&quot;</span>);</span><br><span class="line">    <span class="function"><span class="keyword">co_await</span> <span class="title">connect</span><span class="params">(addresses)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的 <code>addresses</code> 是 <code>dns</code> 异步结果的引用，可能是一个 <code>vector&lt;Address&gt;</code>，这个值应该是被 <code>promise</code> 持有的。下面的 <code>connect</code> 生成了它的视图，指向的还是 <code>promise</code> 包含的值，但是当 <code>connect</code> 里面某个异步操作挂起时，<code>promise</code> 将会消亡，因为它挂钩的 <code>dns</code> 已经完成了，它也不需要再存在了，所以正确的写法是：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> addresses = <span class="keyword">co_await</span> dns::query(<span class="string">&quot;domain&quot;</span>);</span><br><span class="line">    <span class="function"><span class="keyword">co_await</span> <span class="title">connect</span><span class="params">(addresses)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> addresses = <span class="built_in">std</span>::move(<span class="keyword">co_await</span> dns::query(<span class="string">&quot;domain&quot;</span>));</span><br><span class="line">    <span class="function"><span class="keyword">co_await</span> <span class="title">connect</span><span class="params">(addresses)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面两种写法都可以，但是第二种会直接移走 <code>promise</code> 的值，如果还有别的 <code>promise::then</code> 绑定的回调，那么那些回调将获取不到值了，这种情况需要自己辨别。</p>
<blockquote>
<p>任何时候都应该谨慎对待 <code>auto &amp;result = co_await xxx;</code>，大多数情况下它会带来 <code>crash</code>。</p>
</blockquote>
<p>另外可以多一嘴，我为什么要暴露出 <code>promise</code> 结果的左值引用，因为如果不这样做的话，那么 <code>promise</code> 的值就必须是可复制的，类似于 <code>Socket</code> 这类只能被移动的对象就只能用 <code>std::shared_ptr</code> 包裹住了，我并不是很想这样做。而不默认返回右值引用，是因为 <code>promise</code> 的结果并不是只被一人独享的，如果默认将 <code>promise</code> 的结果移走，会导致其它回调访拿到的是 <code>moved</code> 的值。</p>
<h2 id="Lambda"><a href="#Lambda" class="headerlink" title="Lambda"></a>Lambda</h2><p>很不幸，非常不建议使用具有捕获的 <code>lambda</code> 作为协程，看看这个例子：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Task&lt;<span class="keyword">void</span>&gt; <span class="title">func</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> host)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> task = [=]() -&gt; Task&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">auto</span> socket = <span class="keyword">co_await</span> connect(host, <span class="number">443</span>);</span><br><span class="line">        <span class="keyword">co_await</span> socket-&gt;write(xxx);</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; host &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">co_await</span> task;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在执行 <code>co_await task</code> 时，临时的 <code>lambda</code> 对象已经消亡，而它捕获的 <code>host</code> 生命周期也结束了，那么未结束的 <code>task</code> 在恢复执行后将会访问到一个未知值，虽然大多数情况下栈上的数据还没有被改写，<code>host</code> 所指向的内存还是有效的，但恰恰是这暗藏祸根的代码会带来未知的风险。<br>虽然极其不优雅，但是如果想使用 <code>lambda</code> 创建协程只能显式地传参：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Task&lt;<span class="keyword">void</span>&gt; <span class="title">func</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> host)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> task = [](<span class="keyword">auto</span> host) -&gt; Task&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">auto</span> socket = <span class="keyword">co_await</span> connect(host, <span class="number">443</span>);</span><br><span class="line">        <span class="keyword">co_await</span> socket-&gt;write(xxx);</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; host &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;(host);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">co_await</span> task;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rcoro-capture">C++ Core Guidelines</a> 建议尽量使用普通函数创建协程，当然如果你确切地知道自己在干什么，你对自己的代码极度自信，对所有变量的生命周期了如指掌，你可以适当地跳脱于规则之外，毕竟优雅永不过时！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hackerl.github.io/2023/11/02/CPP-%E5%8D%8F%E7%A8%8B%E8%B8%A9%E5%9D%91/" data-id="clogx15ka00009tt23nzsci6i" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-我的家庭网络架构" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/05/24/%E6%88%91%E7%9A%84%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84/" class="article-date">
  <time datetime="2023-05-24T15:33:46.000Z" itemprop="datePublished">2023-05-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/05/24/%E6%88%91%E7%9A%84%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84/">我的家庭网络架构</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>很久没写博客了，最近正好有空可以谈谈我最近更新的家庭网络架构。我所有的网络组件都部署在一台 <code>J1900</code> 的机器上，安装的操作系统是 <code>debian 10</code>，主板配有四个网口。我将其中三个网口合并为一个 <code>bridge</code> 用来构建我的私有子网，供主机和路由器插线连接，另一个网口连接光猫作为出口。</p>
<h2 id="科学上网"><a href="#科学上网" class="headerlink" title="科学上网"></a>科学上网</h2><p>通过在软路由上使用 <code>iptables</code> + <code>tproxy</code> 重定向 <code>TCP/UDP</code> 流量到 <code>clash</code>，可以实现全局翻墙，所有设备无需设置。在讨论我遇到的问题之前，有必要了解一下 <code>clash</code> 在软路由上怎么进行规则判断的，换言之 <code>clash</code> 怎么知道我们当前的连接是否需要走代理。</p>
<h3 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h3><p>软路由上的流量被重定向后，<code>clash</code> 只能获取的目标 <code>ip</code>，但是根据 <code>ip</code> 地区判断是远远不够的，那么该如何获取 <code>ip</code> 对应的域名呢？<code>clash</code> 自带了一个 <code>DNS server</code>，在软路由上将所有 <code>DNS</code> 请求转发给它，那么它就能记录域名和 <code>ip</code> 的对应关系。但是由于存在许多问题，这种 <code>redir-host</code> 模式在较新的 <code>clash</code> 中被删除了。它最大的问题就是无法应对 <code>DNS</code> 污染，例如最上游 DNS 被污染时，返回 <code>google</code> 的 <code>ip</code> 是 <code>127.0.0.1</code> 这种，那么该请求直接在主机上请求失败了。</p>
<h3 id="FakeIP"><a href="#FakeIP" class="headerlink" title="FakeIP"></a>FakeIP</h3><p>在使用 <code>redir-host</code> 的过程中，我经常遇到网络不正常的情况，迫于无奈只能切换到 <code>fake-ip</code> 模式。它的原理就是 <code>clash</code> 的 <code>DNS server</code> 返回一个虚假的内网 <code>ip</code>，例如 <code>198.168.0.0/16</code>，同时记录 <code>ip</code> 与 <code>hostname</code> 的对应关系，这样就可以避免 <code>DNS</code> 污染的问题。当然 <code>fake-ip</code> 也有缺陷，例如 <code>QQ</code> 的某些域名指向就是 <code>127.0.0.1</code>，因为需要和 <code>QQ</code> 客户端通信，另外 <code>Windows</code> 的网络探测服务也无法在 <code>fake-ip</code> 模式下工作。对于这些特殊的域名，我们可以在 <code>clash</code> 配置中过滤掉，让它们返回真实的查询结果。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dns:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">ipv6:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">listen:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:5300</span></span><br><span class="line">  <span class="attr">enhanced-mode:</span> <span class="string">fake-ip</span></span><br><span class="line">  <span class="attr">fake-ip-range:</span> <span class="number">198.18</span><span class="number">.0</span><span class="number">.1</span><span class="string">/16</span></span><br><span class="line">  <span class="attr">nameserver:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">https://doh.pub/dns-query</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">https://dns.alidns.com/dns-query</span></span><br><span class="line">  <span class="attr">fake-ip-filter:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*.lan&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;wspeed.qq.com&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;internal-api-lark-file.feishu.cn&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;jrlt.beacon.qq.com&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;localhost.ptlogin2.qq.com&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;+.srv.nintendo.net&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;+.stun.playstation.net&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;+.msftconnecttest.com&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;+.msftncsi.com&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;+.xboxlive.com&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;msftconnecttest.com&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;xbox.*.microsoft.com&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*.battlenet.com.cn&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*.battlenet.com&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*.blzstatic.cn&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*.battle.net&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="游戏加速"><a href="#游戏加速" class="headerlink" title="游戏加速"></a>游戏加速</h2><p>游戏加速说到底还是代理，只不过是延迟很低的线路，使用小米等路由器同时开启翻墙和游戏加速插件肯定会有冲突，但是在自己配置的 <code>Linux</code> 路由器里，我可以精准地控制每一条规则。</p>
<h3 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h3><p>一年前我的方案是将 <code>openwrt</code> 版本的 <code>UU加速器</code> 跑在 <code>docker</code> 里，它其实是一个为主机加速提供的方案，所以我写了个 <code>python</code> 脚本将我的软路由伪装成 <code>PS4</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">UDP_IP = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">UDP_PORT = <span class="number">987</span></span><br><span class="line"></span><br><span class="line">sock = socket.socket(socket.AF_INET,socket.SOCK_DGRAM)</span><br><span class="line">sock.bind((UDP_IP, UDP_PORT))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    data, addr = sock.recvfrom(<span class="number">1024</span>)</span><br><span class="line">    print(<span class="string">&quot;received message from %s[%d]: %s&quot;</span> % (addr[<span class="number">0</span>], addr[<span class="number">1</span>], data.decode(<span class="string">&#x27;utf8&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">    response = <span class="string">&quot;HTTP/1.1 200 OK\r\nhost-id:0123456789AB\r\nhost-type:PS4\r\nhost-name:MyPS4\r\nhost-request-port:%d\r\ndevice-discovery-protocol-version:00020020\r\nsystem-version:07020001\r\nrunning-app-name:Youtube\r\nrunning-app-titleid:CUSA01116\r\n\r\n&quot;</span> % addr[<span class="number">1</span>]</span><br><span class="line">    sock.sendto(response.encode(<span class="string">&#x27;utf8&#x27;</span>), addr)</span><br></pre></td></tr></table></figure>
<p>想象一下，<code>UU加速器</code> 在容器 <code>172.17.0.3</code> 中广播 <code>UDP</code> 包，然后这个脚本在软路由的 <code>172.17.0.1</code> 上收到了这个包，并成功回复让对方认为自己是一台 <code>PS4</code>。然后在手机 <code>APP</code> 上就可以开启加速，这个时候我们只需要在软路由上将需要加速的包路由给 <code>172.17.0.3</code> 即可，流量会顺利地从容器的 <code>tun</code> 网卡进入 <code>UU加速器</code> 的专线。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://github.com/Hackerl/docker-uuplugin</span></span><br><span class="line">docker build -t docker-uuplugin . --build-arg UU_IP=172.17.0.3</span><br><span class="line">docker run -d -p 16363:16363 --<span class="built_in">cap</span>-add NET_ADMIN --device /dev/net/tun:/dev/net/tun -it docker-uuplugin</span><br></pre></td></tr></table></figure>
<p>启动后添加路由规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip rule add fwmark 0x163 table 0x163</span><br><span class="line">ip route add default via 172.17.0.3 table 0x163</span><br></pre></td></tr></table></figure>
<p>这个路由规则的意思是如果流量带有 0x163 标志，那么就路由给 <code>172.17.0.3</code>，接着我们可以在 <code>iptables</code> 里给特定流量打上标志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -t mangle -N UUPLUGIN</span><br><span class="line">iptables -t mangle -A UUPLUGIN -p udp -s 192.168.10.0/24 --dport 32768:65534 -j MARK --<span class="built_in">set</span>-mark 0x163</span><br><span class="line">iptables -t mangle -A UUPLUGIN -p udp -s 192.168.10.0/24 --dport 10000:32768 -j MARK --<span class="built_in">set</span>-mark 0x163</span><br><span class="line">iptables -t mangle -A UUPLUGIN -p udp -s 192.168.10.0/24 --dport 1025:9999 -j MARK --<span class="built_in">set</span>-mark 0x163</span><br><span class="line">iptables -t mangle -A UUPLUGIN -m mark --mark 0x163 -j ACCEPT</span><br><span class="line">iptables -t mangle -A PREROUTING -j UUPLUGIN</span><br></pre></td></tr></table></figure>
<p>例如我们给 <code>UDP</code> 高端口号的包打上标志，这其实是大多数网络游戏的通讯方式，例如英雄联盟。</p>
<h3 id="虚拟机"><a href="#虚拟机" class="headerlink" title="虚拟机"></a>虚拟机</h3><p>使用 <code>docker</code> 运行 <code>UU加速器</code> 进行游戏加速也存在问题，一就是可选择的节点并不多，毕竟这是主机加速方案，二就是它的 <code>iptables</code> 限制了只代理某些源 <code>ip</code>。由于第二个限制，我们没有办法直接在它的容器中部署 <code>socks5</code> 代理，以集成到 <code>clash</code> 规则中，当然我可以修改它的规则，但是每次启动加速都要修改的话太麻烦了。此时我有了一个大胆的想法，我可不可以在软路由上跑一个 <code>windows</code> 虚拟机，然后将流量转发到虚拟机中去加速，一想到 <code>J1900</code> 廉价的性能我心里就充满了问号。<br>我首先安装了一个 <code>windows 7</code> 虚拟机，连上 <code>VNC</code> 后果然很卡，然后部署了一个简单的 <code>socks5</code> 代理，接着将英雄联盟台服的域名全部抠出来，写好 <code>clash</code> 规则：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="attr">engine:</span> <span class="string">expr</span></span><br><span class="line">  <span class="attr">shortcuts:</span></span><br><span class="line">    <span class="attr">game:</span> <span class="string">network</span> <span class="string">==</span> <span class="string">&#x27;udp&#x27;</span> <span class="string">and</span> <span class="string">dst_port</span> <span class="string">&gt;=</span> <span class="number">1025</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">SCRIPT,game,GAME</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">DOMAIN,lolstatic-a.akamaihd.net,GAME</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">DOMAIN-KEYWORD,riot,GAME</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">DOMAIN-SUFFIX,pvp.net,GAME</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">DOMAIN-SUFFIX,leagueoflegends.com,GAME</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">DOMAIN-SUFFIX,newrelic.com,GAME</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">DOMAIN,lolesports.com,GAME</span></span><br></pre></td></tr></table></figure>
<p>尝试了一下确实可以工作，所有英雄联盟相关的流量都由虚拟机代理。那么接下来要做的就是怎么把这台虚拟机压缩一下，<code>J1900</code> 的确有点带不动，而且为了一个游戏加速我也并不是很乐意耗费这么多 <code>CPU</code> 和内存。我在网上找到了一个 <a target="_blank" rel="noopener" href="https://archive.org/details/windows-7x-86-supernano-final"><code>Windows 7 Super-Nano Lite</code></a>，镜像居然只有 <code>316MB</code>，确定这可以跑起来吗？我安装了一下确实跑起来了，但是包括网络驱动之类的东西全部被删除了。</p>
<p><img src="https://i.imgur.com/lrxyn0j.png"></p>
<p>磁盘占用只有 <code>600MB</code>，内存也只用了 <code>200MB</code>，为了进一步优化性能，我使用 <code>virt-install</code> 安装虚拟机时设置的网络和磁盘驱动都是 <code>virtio</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.173-4/virtio-win-0.1.173_x86.vfd</span><br><span class="line">sudo virt-install --name=win7 --virt-type kvm --memory 1024 --vcpus=1 --os-type=windows --os-variant win7 --disk path=win7.qcow2,format=qcow2,bus=virtio --cdrom Windows7SuperNanoLite.iso --graphics vnc,listen=0.0.0.0 --network default,model=virtio --disk path=virtio-win-0.1.173_x86.vfd,device=floppy --noautoconsole</span><br></pre></td></tr></table></figure>
<p>在使用 <code>VNC</code> 安装的时候会提示找不到驱动器，因为 <code>windows 7</code> 无法识别 <code>virtio</code> 设备，所有在界面上点击加载驱动，加载 <code>virtio-win-0.1.173_x86.vfd</code> 软盘中的磁盘和网络驱动。安装后的系统是无法显示中文的，因为中文包也被删除了。找一台完整的 <code>windows 7</code> 机器，拷贝 <code>C:\Windows\System32\C_936.NLS</code> 以及 <code>C:\Windows\Fonts\msyh.ttf</code> 到虚拟机中，中文就不会乱码了。安装完加速器后，需要部署一个支持 <code>TCP/UDP</code> 的 <code>socks5</code> 代理，我找了一圈发现没几个支持 <code>UDP</code> 的，最后选择了 <a target="_blank" rel="noopener" href="https://github.com/3proxy/3proxy/issues"><code>3proxy</code></a>，配置文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;local&#x2F;bin&#x2F;3proxy</span><br><span class="line"></span><br><span class="line">system &quot;echo 3proxy up!&quot;</span><br><span class="line"></span><br><span class="line">########### SERVICE ###########</span><br><span class="line"># Set timeouts</span><br><span class="line">timeouts 1 5 30 60 180 1800 15 60</span><br><span class="line"></span><br><span class="line"># Service installation, daemon for nix, service for win32</span><br><span class="line">#daemon</span><br><span class="line">service</span><br><span class="line"></span><br><span class="line">########### LOGGING ###########</span><br><span class="line"># Set up logs</span><br><span class="line">#log &quot;&#x2F;var&#x2F;logs&#x2F;3proxy&#x2F;%Y%m%d.log&quot; D</span><br><span class="line">log &quot;3proxy-%Y%m%d.log&quot; D</span><br><span class="line">logformat &quot;- +_L%t.%. %Y-%m-%d  %N.%p %E %U %C:%c %R:%r %O %I %h %T&quot;</span><br><span class="line">archiver rar rar a -df -inul %A %F</span><br><span class="line">rotate 30</span><br><span class="line"></span><br><span class="line">########### IFACE ###########</span><br><span class="line"># External is the interface you will send data out from, set with a static IP</span><br><span class="line">external 0.0.0.0</span><br><span class="line"># Internal is the interface you will listen on, in this case localhost (no physical nic)</span><br><span class="line">internal 0.0.0.0</span><br><span class="line"></span><br><span class="line">########### SOCKS ###########</span><br><span class="line"># Socks5  proxy setup</span><br><span class="line">auth none</span><br><span class="line">flush</span><br><span class="line">maxconn 300</span><br><span class="line">socks</span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/1TkKfYn.png"></p>
<p>搞完这个之后在英雄联盟台服开了把大乱斗，延迟居然才 30 比国服还低，看了下软路由的资源占用，虚拟机低负载时 <code>qemu</code> 进程稳定占用 45% 左右的单核 <code>CPU</code>，算是可以接受的范围，毕竟它只是 <code>J1900</code> 啊！有了这个比较稳定的虚拟方案后，其实可以将一些 <code>windows</code> 独占的软件放到里面，通过软路由上的 <code>smb</code> 共享文件，但是我现在使用的百度云、迅雷都是使用的 <code>docker</code> + <code>noVNC</code> 方案，暂时没有其余想折腾的东西了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hackerl.github.io/2023/05/24/%E6%88%91%E7%9A%84%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84/" data-id="clogx15kg000a9tt23x3pcbfa" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Nokia-7P-刷机" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/10/21/Nokia-7P-%E5%88%B7%E6%9C%BA/" class="article-date">
  <time datetime="2022-10-21T14:39:48.000Z" itemprop="datePublished">2022-10-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/10/21/Nokia-7P-%E5%88%B7%E6%9C%BA/">Nokia 7P 刷机</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我有一台老旧的 <code>Nokia 7P</code> 手机，购买于 2018 年暑假，当时看中的主要是它的类原生系统，它也在后续的工作中陪伴了我 4 年。虽然现在已经换成了苹果，但是平时看视频之类的娱乐还是停留在它上面。之前就一直想在这台 <code>Nokia 7P</code> 上安装第三方系统，但是由于尝试解锁 <code>bootloader</code> 一直失败，只能暂且作罢。<br>最近在网上看到了一篇解锁 <code>bootloader</code> 的<a target="_blank" rel="noopener" href="https://www.techmesto.com/guide-unlock-bootloader-nokia-android-phones/">文章</a>，貌似已经有三方的工具公开了，随即摩拳擦掌跃跃欲试，挑了个空闲的日子开始这趟刷机之旅。</p>
<h2 id="驱动"><a href="#驱动" class="headerlink" title="驱动"></a>驱动</h2><p>在诺基亚关机状态下，长按电源键与音量加可以进入 <code>bootloader</code> 模式，此时可以使用 <code>Android SDK</code> 提供的 <code>fastboot</code> 工具刷入 <code>recovery</code>，比如常见的 <code>TWRP</code>，这是刷机的首要步骤。然而将 <code>bootloader</code> 模式下的手机使用 <code>USB</code> 连接电脑，电脑是无法识别的，因为缺少了驱动程序。<br>安装驱动程序最简单的方式就是在手机开机状态下，使用 <code>USB</code> 连接电脑，会自动从手机挂载出一个 <code>CD-ROM</code> 盘符，里面就有官方驱动安装程序，更多的安装方式可以参考这篇<a target="_blank" rel="noopener" href="https://www.techmesto.com/download-official-nokia-usb-drivers-for-windows-adb-fastboot-others/">文章</a>。<br>安装完驱动后打开设备管理器，如果能看到 <code>bootloader</code> 状态下的手机被识别成 <code>fastboot</code> 设备，则说明驱动已正常运行。</p>
<h2 id="解锁"><a href="#解锁" class="headerlink" title="解锁"></a>解锁</h2><p>在驱动安装完成的情况下，按照第一篇文章的步骤，下载 <code>Unlock Tool</code> 并在<a target="_blank" rel="noopener" href="https://www.techmesto.com/nokia-ubl-otp/">网页</a>上获取 <code>OPT</code> 口令。每天的 <code>OPT</code> 口令有上限，先到先得，并且每个口令有效期为 15 分钟。打开工具输入 <code>OPT</code>，并且使用 <code>USB</code> 连接处于 <code>bootloader</code> 模式下的手机，点击解锁按钮即可。</p>
<h2 id="TWRP"><a href="#TWRP" class="headerlink" title="TWRP"></a>TWRP</h2><p>成功解锁 <code>bootloader</code> 后，我们可以无限制的刷入三方固件了，首先要准备的是 <a target="_blank" rel="noopener" href="https://twrp.me/nokia/nokia7plus.html">TWRP</a>，从网站上下载最新固件并命名为 <code>twrp.img</code>。<br>我首次尝试在 <code>bootloader</code> 模式中直接刷入固件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastboot flash recovery twrp.img</span><br></pre></td></tr></table></figure>
<p>但是显示如下错误：</p>
<blockquote>
<p>FAILED (remote: (recovery_b) No such partition)</p>
</blockquote>
<p>于是我选择载入到 <code>TWRP</code> 中进行安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastboot boot twrp.img</span><br></pre></td></tr></table></figure>
<p>手机自动重启后，便进入了 <code>TWRP</code> 中，此时可以在选项中将当前 <code>TWRP</code> 覆盖手机的 <code>recovery</code>。</p>
<h2 id="AB-分区"><a href="#AB-分区" class="headerlink" title="AB 分区"></a>AB 分区</h2><p>较新的手机现在都是有 AB 分区的，可以安装两个独立的系统，在 <code>bootloader</code> 模式下可以选择进入的分区：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastboot set_active [a|b]</span><br></pre></td></tr></table></figure>
<p>如果你在 A 分区安装了系统，但是激活了 B 分区，那么重启手机后将无法成功进入系统。同样，AB 分区也有两套 <code>recovery</code>，如果你只是将 <code>TWRP</code> 安装在 B 分区，那么 A 分区的 <code>recovery</code> 还是自带的。我将 <code>TWRP</code> 安装在了 B 分区，如果此时激活的是 A 分区，那么可以使用如下命令可以进入 B 分区的 <code>recovery</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fastboot set_active b</span><br><span class="line">fastboot reboot recovery</span><br></pre></td></tr></table></figure>
<h2 id="刷机"><a href="#刷机" class="headerlink" title="刷机"></a>刷机</h2><p>我选择的三方固件是 <code>LineageOS</code>，可以在<a target="_blank" rel="noopener" href="https://forum.xda-developers.com/t/closed-rom-12-0-onyx-lineageos-19-0-unofficial.3993445/">论坛</a>中下载镜像。在 <code>TWRP</code> 中，可以直接通过 <code>USB</code> 传输文件，也可以使用 <code>adb</code> 命令，能够很方便地将系统包传输到手机中。<br>在 <code>TWRP</code> 的界面中，先擦除掉所有数据，再进入安装界面并选中系统包开始刷入。如果此时激活的是 B 分区，那么系统的安装会默认选择 A 分区。安装完后重启之前，需要切换到 A 分区，然后重启。</p>
<h2 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h2><p>在首次刷入系统包时报错：</p>
<blockquote>
<p>TWRP Error Applying Update: 28 kDownloadOperationExecutionError</p>
</blockquote>
<p>搜索后得知是因为 <code>Nokia</code> 默认的 <code>system</code> 分区空间太小，需要重新分区，使用 <a target="_blank" rel="noopener" href="https://forum.xda-developers.com/t/closed-guide-repartition-tool-for-nokia-6-1-plus-x6.4334461/">Repartition tool</a> 重新分区后重复上诉步骤即可。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hackerl.github.io/2022/10/21/Nokia-7P-%E5%88%B7%E6%9C%BA/" data-id="clogx15ke00059tt211u50t9n" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Elkeid-Golang-RASP" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/02/28/Elkeid-Golang-RASP/" class="article-date">
  <time datetime="2022-02-28T08:16:45.000Z" itemprop="datePublished">2022-02-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/02/28/Elkeid-Golang-RASP/">Elkeid Golang RASP</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在以往的 <code>RASP</code> 解决方案中，部署方式通常需要业务参与，修改相关配置或是启动参数，这也就造成了 <code>RASP</code> 部署困难的窘境。更有甚者，由于 <code>Golang</code> 编译型语言的特性，多数 <code>RASP</code> 只能被迫选择在编译期集成进去，以降低技术实现成本，但这无疑又间接加大了部署推广的难度。<br>我始终认为限制 <code>RASP</code> 发展与推广的是部署，而并非是技术难度，许多厂商在各语言的技术实现上都有大同小异的成熟方案。例如使用 <code>JVM</code> 的 <code>Instrumentation</code> 功能动态修改 <code>bytecode</code>，可以在虚拟机功能的基础上实现稳定的运行时防护。<br>所以在 <code>Elkeid RASP</code> 的项目初期，团队就敲定了动态注入的部署方式，一切都朝着降低部署难度的目标靠拢。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>目前 <code>Elkeid RASP</code> 开源了 <code>JVM</code>、<code>Python</code>、<code>Node</code> 以及 <code>Golang</code> 四种语言的运行时保护功能，四种语言均支持对已存在的进程动态注入防护代码。其中 <code>JVM</code>、<code>Node</code> 依赖于虚拟机提供的机制，运行稳定，而 <code>Python</code> 与 <code>Golang</code> 则需要利用 <code>ptrace</code> 在进程层面上做注入。</p>
<h3 id="进程注入"><a href="#进程注入" class="headerlink" title="进程注入"></a>进程注入</h3><p>为了实现对 <code>Python</code> 以及 <code>Golang</code> 进程的动态防护，先不考虑运行时层面的代码篡改，我们至少需要一个能够在 <code>Linux</code> 任意进程空间内执行任意代码的工具。但是很可惜，<code>Linux</code> 没有类似于 <code>CreateRemoteThread</code> 的接口。<br>大多数的代码注入，都是使用 <code>ptrace</code> 篡改进程执行流程，调用 <code>dlopen</code> 加载动态库。而且大多数项目都会指出，该方式的不稳定性可能会导致进程永久卡住。因为 <code>dlopen</code> 底层会调用 <code>malloc</code>，而在 <code>glibc</code> 的官方文档中指明了 <code>malloc</code> 是不可重入函数。<br>在研究过程中，我发现了 <a target="_blank" rel="noopener" href="https://github.com/ixty/mandibule">mandibule</a> 这个项目，它另辟蹊径地编写了一个 ELF Loader，再使用 <code>ptrace</code> 让该 ELF Loader 在目标进程内执行，加载一个全新的程序，执行完成后恢复主线程的寄存器。<br>由于作者已经放弃维护，而且我自己在使用过程中，发现了项目一些设计上的缺陷以及代码 bug。于是我借鉴了该思路，开发了 <a target="_blank" rel="noopener" href="https://github.com/Hackerl/pangolin">pangolin</a> 这个工具，它可以在任意进程内临时运行另一个程序，细节可以看相关的 <a href="https://hackerl.github.io/2021/02/11/Linux%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5/">blog</a>。</p>
<h3 id="Inline-Hook"><a href="#Inline-Hook" class="headerlink" title="Inline Hook"></a>Inline Hook</h3><p>借助 <code>pangolin</code>，我们可以在一个 <code>Golang</code> 的进程中执行任意代码，我们甚至可以篡改可执行段的机器码，很轻松地便可以对某个函数进行 <code>Inline Hook</code>。例如我们想对 <code>Golang</code> 的命令执行函数 <code>exec.Command</code> 进行 <code>Inline Hook</code>，那么可以在进程注入期间修改函数 <code>os/exec.Command</code> 的开头指令，使其执行时先跳转到我们编写的函数中。在我们自定义的函数中，便可以获取该函数调用时的入参以及调用栈，再通过某种通信方式传输出去，一个简单的 <code>RASP</code> 模型便完成了。<br>那么要完成该流程，我们需要一些先决条件：</p>
<ul>
<li>在去除掉 <code>ELF</code> 符号信息的情况下，如何获取 <code>Golang</code> 的符号信息，以确定函数的地址，完成对函数的 <code>Inline Hook</code> 操作。</li>
<li><code>Golang</code> 如何进行函数调用，通过寄存器亦或是栈，我们又该如何读取函数的入参。</li>
<li>如何获取 <code>Golang</code> 当前函数的 <code>Stack Frame</code> 长度，用于定位上一层函数的返回地址，完成调用栈回溯。</li>
</ul>
<h3 id="Golang-Runtime-Symbol-Information"><a href="#Golang-Runtime-Symbol-Information" class="headerlink" title="Golang Runtime Symbol Information"></a>Golang Runtime Symbol Information</h3><p>在去除了 <code>ELF</code> 符号信息后，一个编译好的 <code>Golang</code> 程序还是可以正确地执行 <code>debug.PrintStack</code> 函数，那么便可以证明 <code>Golang</code> 内部必然还存在一个符号表。根据官方文档 <a target="_blank" rel="noopener" href="https://docs.google.com/document/d/1lyPIbmsYbXnpNj57a261hgOYVpNRcgydurVQIyZOz_o/pub">Go 1.2 Runtime Symbol Information</a> 的介绍，<code>Golang</code> 从 1.2 之后的版本内置了符号信息，对于 <code>ELF</code> 格式来说，通常放置在 <code>.gopclntab</code> 这个 <code>section</code>。<br>这些符号信息不仅包含了函数名称、函数地址范围以及函数栈帧长度信息，甚至还有相关的代码文件名，以及行号等源码信息。根据文档记录的信息格式，我们可以很轻松地解析出一个 <code>Golang</code> 二进制程序的符号表。</p>
<h3 id="Golang-build-info"><a href="#Golang-build-info" class="headerlink" title="Golang build info"></a>Golang build info</h3><p>对于 <code>Golang</code> 1.13 以上编译出的二进制，可以使用 <code>go version</code> 命令查看编译时的 <code>Golang</code> 版本，由此说明二进制中内嵌了相关的编译信息。对于 <code>ELF</code> 格式来说，编译信息存放在 <code>.go.buildinfo</code> <code>section</code>，其中包含 <code>Golang</code> 版本号以及三方依赖库列表。值得注意的是，<code>buildinfo</code> 的格式在 <code>Golang</code> 1.18 版本发生了改变，弃用了数据指针，相关解析代码可查看<a target="_blank" rel="noopener" href="https://github.com/bytedance/Elkeid/blob/main/rasp/golang/go/symbol/build_info.cpp">官方仓库</a>。</p>
<h3 id="Golang-internal-ABI"><a href="#Golang-internal-ABI" class="headerlink" title="Golang internal ABI"></a>Golang internal ABI</h3><p>接下来我们需要了解 <code>Golang</code> 编译出的机器码，是如何进行函数调用的，以及 <code>Golang</code> 的结构体在内存中是如何存放的，了解这些之后我们才能正确地取出函数入参。</p>
<h4 id="memory-layout"><a href="#memory-layout" class="headerlink" title="memory layout"></a>memory layout</h4><p><code>Golang</code> 包含的内置类型描述，可以在官方文档 <a target="_blank" rel="noopener" href="https://go.dev/ref/spec#Types">The Go Programming Language Specification</a> 中找到。对于数值类型，<code>Golang</code> 规范了类型的<a target="_blank" rel="noopener" href="https://go.dev/ref/spec#Size_and_alignment_guarantees">内存占用大小</a>，而字节对齐则随 <code>CPU</code> 架构不同而变化。对于复合类型，例如 <code>string</code>、<code>slice</code> 以及 <code>map</code> 等，内存占用大小由组成的基础类型及其字节对齐决定，而该复合类型的字节对齐由组成类型中最大的字节对齐决定。<br>文档中并未描述 <code>string</code> 等内置类型的底层内存排布，但是我们可以从一些<a target="_blank" rel="noopener" href="https://go101.org/article/string.html">文章</a>，亦或是 <code>CGO</code> 生成的头文件中一窥究竟。<br>以下是我使用 <code>cpp</code> 对 <code>x64</code> 架构下 <code>Golang</code> 类型的描述，代码可以在 <code>Elkeid</code> 官方<a target="_blank" rel="noopener" href="https://github.com/bytedance/Elkeid/blob/main/rasp/golang/go/type/basic.h">仓库</a>中找到：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> go &#123;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">signed</span> <span class="keyword">char</span> Int8;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> Uint8;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">short</span> Int16;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> Uint16;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">int</span> Int32;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> Uint32;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> Int64;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> Uint64;</span><br><span class="line">    <span class="keyword">typedef</span> Int64 Int;</span><br><span class="line">    <span class="keyword">typedef</span> Uint64 Uint;</span><br><span class="line">    <span class="keyword">typedef</span> __SIZE_TYPE__ Uintptr;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">float</span> Float32;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">double</span> Float64;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">float</span> <span class="built_in">_Complex</span> Complex64;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">double</span> <span class="built_in">_Complex</span> Complex128;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">interface</span> &#123;</span></span><br><span class="line">        <span class="keyword">void</span> *t;</span><br><span class="line">        <span class="keyword">void</span> *v;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">string</span> &#123;</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *data;</span><br><span class="line">        <span class="keyword">ptrdiff_t</span> length;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">slice</span> &#123;</span></span><br><span class="line">        T *values;</span><br><span class="line">        Int count;</span><br><span class="line">        Int capacity;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>string</code> 类型由两个字段组成，数据指针加上字符串长度，在内存中总共占用 16 字节。<code>string</code> 的内存对齐则由这两个字段决定，即 <code>align(string) = max(align(const char *), align(ptrdiff_t))</code>。<br>对于 <code>int32</code> 这些 <code>Golang</code> 的基础数值类型来说，其字节对齐与 <code>cpp</code> 默认的对齐一致。</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>64-bit</th>
<th></th>
<th>32-bit</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>Size</td>
<td>Align</td>
<td>Size</td>
<td>Align</td>
</tr>
<tr>
<td>bool, uint8, int8</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>uint16, int16</td>
<td>2</td>
<td>2</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>uint32, int32</td>
<td>4</td>
<td>4</td>
<td>4</td>
<td>4</td>
</tr>
<tr>
<td>uint64, int64</td>
<td>8</td>
<td>8</td>
<td>8</td>
<td>4</td>
</tr>
<tr>
<td>int, uint</td>
<td>8</td>
<td>8</td>
<td>4</td>
<td>4</td>
</tr>
<tr>
<td>float32</td>
<td>4</td>
<td>4</td>
<td>4</td>
<td>4</td>
</tr>
<tr>
<td>float64</td>
<td>8</td>
<td>8</td>
<td>8</td>
<td>4</td>
</tr>
<tr>
<td>complex64</td>
<td>8</td>
<td>4</td>
<td>8</td>
<td>4</td>
</tr>
<tr>
<td>complex128</td>
<td>16</td>
<td>8</td>
<td>16</td>
<td>4</td>
</tr>
<tr>
<td>uintptr, *T, unsafe.Pointer</td>
<td>8</td>
<td>8</td>
<td>4</td>
<td>4</td>
</tr>
</tbody></table>
<p>但是 <code>Golang</code> 并不确保这些类型的字节对齐不变，官方似乎正在考虑改变 <code>x86</code> 上 <code>int64</code> 的字节对齐。现在我们已经了解了 <code>Golang</code> 类型的内存排布，那么对于任意入参的函数调用，我们都能准确的从内存中取出数据。现在剩下的问题便是函数调用发生时，参数将会存放在何处？</p>
<h4 id="stack-based-calling-conventions"><a href="#stack-based-calling-conventions" class="headerlink" title="stack-based calling conventions"></a>stack-based calling conventions</h4><p><code>Golang</code> 在 1.17 版本之前的函数调用中，参数与结果均存放在栈上。但由于栈上频繁的内存操作影响了运行性能，所以社区草拟了<a target="_blank" rel="noopener" href="https://go.googlesource.com/proposal/+/master/design/40724-register-calling.md">基于寄存器的调用约定方案</a>，并在 1.17 版本后切换到该调用约定。<br>我们先了解 <code>Golang</code> 最原始的 <code>ABI0</code>，也就是基于栈的调用约定，细节描述可以从文档 <a target="_blank" rel="noopener" href="https://go.dev/doc/asm">A Quick Guide to Go’s Assembler</a> 找到。在函数调用发生时，调用者需要将参数以及返回值，从低地址向高地址依次排列在栈顶。<br>例如在调用函数 <code>func A(a int32, b string) (int32, error)</code> 时，我们需要按下列排布存放参数与返回值：</p>
<pre><code>+------------------------------+
| 2nd result error.v           |
| 2nd result error.t           |
| 1st result int32             |
| &lt;pointer-sized alignment&gt;    |
| b string.length              |
| b string.data                |
| a int32                      |
+------------------------------+ ↓ stack pointer</code></pre>
<p>先放入 4 字节的参数 a，接着放入 <code>string</code> 类型的参数 b。由于 <code>string</code> 类型的字节对齐是 8，而此时的地址为 <code>sp + 4</code>，所以需要填充 4 字节的空白区域，从 <code>sp + 8</code> 开始放置 <code>string</code> 的数据。参数存放完成后，如果此时的地址没有按指针大小对齐，则需要填充空白字节。例如在 <code>amd64</code> 架构上，最后一个 <code>int32</code> 的参数放置于地址 0x40000，占用 4 字节大小，那么我们需要再填充 4 字节空白数据，使得返回值存放地址为 0x40008，按当前架构的指针大小 8 对齐。<br>我们接着放入第一个 <code>int32</code> 的返回值，而第二个返回值类型为 <code>error</code>，实际上就是 <code>interface</code> 类型。由上一小结可知，<code>interface</code> 类型占用 16 字节，按 8 字节对齐，所以我们填充 4 字节后，放入 <code>error</code> 结构体。当然，对于返回值而言，我们并不会真正地写入数据，而是预留内存空间以供被调用者写入。</p>
<h4 id="register-based-calling-conventions"><a href="#register-based-calling-conventions" class="headerlink" title="register-based calling conventions"></a>register-based calling conventions</h4><p>对于基于寄存器的调用约定，调用者需要先尝试将参数放置于寄存器中。如果结构体太大，或是结构体中包含 <code>Non-trivial arrays</code> 类型成员导致无法存放，则会转而放置于栈上。对于 <code>amd64</code> 架构，<code>Golang</code> 使用<code>X0</code> – <code>X14</code> 寄存器存放浮点数数据，而对于整数数值，则使用以下 9 个整数寄存器存放：</p>
<pre><code>RAX, RBX, RCX, RDI, RSI, R8, R9, R10, R11</code></pre>
<p>对于数值类型参数，我们可以直接将参数一一对应到寄存器中。而对于结构体类型，我们需要将结构体拆解成多个基础数值类型，然后进行对应放置。如果一个结构体拆解后，需要占用的寄存器数超过了剩余的寄存器数，则该整个结构体都只能放置于栈上。该部分细节繁杂，本文不作赘述，细节请看文档 <a target="_blank" rel="noopener" href="https://go.googlesource.com/go/+/refs/heads/dev.regabi/src/cmd/compile/internal-abi.md">Go internal ABI specification</a>。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="Runtime-conflict"><a href="#Runtime-conflict" class="headerlink" title="Runtime conflict"></a>Runtime conflict</h3><p>有了上述理论支持后，我们现在可以着手编写钩子函数了。在钩子函数执行过程中，不能随意篡改堆栈上的数据，执行完成后需要恢复所有寄存器，并跳转到原函数继续执行。需要注意的是，我们必须时刻记住，执行钩子函数的是 <code>Golang</code> 的线程，那么就存在以下两个问题：</p>
<ul>
<li><code>Golang</code> 为线程分配的栈空间很小，钩子函数如果使用过度会导致 <code>Segmentation fault</code>。</li>
<li>在 <code>Golang</code> 的线程中执行时，我们无法正常调用 <code>glibc</code> 函数，例如 <code>malloc</code> 依赖于 <code>fs</code> 寄存器指向的 <code>TLS</code> 结构，以保证线程安全，但 <code>fs</code> 在 1.17 版本以下的 <code>Golang</code> 线程中指向全局 <code>G</code>。</li>
</ul>
<p>为了解决第一个问题，我们需要在钩子函数的入口处，申请一块足够大的内存替换当前栈。而对于第二点，我们只能使用<code>freestanding</code> 代码及 <code>syscall</code> 来完成参数读取与栈回溯操作。为了更好地解耦与复用，于是我开发了一个不依赖于 <code>glibc</code> 的小型 <a target="_blank" rel="noopener" href="https://github.com/Hackerl/c-runtime">c-runtime</a>，包含内联汇编编写的 <code>syscall</code> 以及必要的标准库函数。我们可以安全地在 <code>Golang</code> 线程中调用 <code>c-runtime</code> 中的任何函数，例如使用底层是无锁环形缓冲区和 <code>mmap syscall</code> 的 <code>z_malloc</code> 来分配堆空间。</p>
<h3 id="钩子函数"><a href="#钩子函数" class="headerlink" title="钩子函数"></a>钩子函数</h3><p>下面是使用内联汇编编写的钩子函数 <code>wrapper</code>，可以通用地进行栈替换、寄存器备份以及函数跳转：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;mov $1, %%r12;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;mov %%rsp, %%r13;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $8, %%r13;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;and $15, %%r13;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu %%xmm14, (%%rsp);&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu %%xmm13, (%%rsp);&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu %%xmm12, (%%rsp);&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu %%xmm11, (%%rsp);&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu %%xmm10, (%%rsp);&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu %%xmm9, (%%rsp);&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu %%xmm8, (%%rsp);&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu %%xmm7, (%%rsp);&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu %%xmm6, (%%rsp);&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu %%xmm5, (%%rsp);&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu %%xmm4, (%%rsp);&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu %%xmm3, (%%rsp);&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu %%xmm2, (%%rsp);&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu %%xmm1, (%%rsp);&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu %%xmm0, (%%rsp);&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;push %%r11;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;push %%r10;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;push %%r9;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;push %%r8;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;push %%rsi;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;push %%rdi;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;push %%rcx;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;push %%rbx;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;push %%rax;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;sub %%r13, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;mov %0, %%rdi;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;call z_malloc;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;cmp $0, %%rax;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;je end_%=;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;mov %%rsp, %%rdi;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;mov %%rax, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add %0, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;push %%rax;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;push %%rdi;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $312, %%rdi;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add %%r13, %%rdi;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;call %P1;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;mov %%rax, %%r12;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;pop %%rsi;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;pop %%rdi;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;mov %%rsi, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;call z_free;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;end_%=:&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add %%r13, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;pop %%rax;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;pop %%rbx;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;pop %%rcx;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;pop %%rdi;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;pop %%rsi;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;pop %%r8;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;pop %%r9;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;pop %%r10;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;pop %%r11;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu (%%rsp), %%xmm0;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu (%%rsp), %%xmm1;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu (%%rsp), %%xmm2;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu (%%rsp), %%xmm3;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu (%%rsp), %%xmm4;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu (%%rsp), %%xmm5;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu (%%rsp), %%xmm6;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu (%%rsp), %%xmm7;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu (%%rsp), %%xmm8;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu (%%rsp), %%xmm9;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu (%%rsp), %%xmm10;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu (%%rsp), %%xmm11;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu (%%rsp), %%xmm12;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu (%%rsp), %%xmm13;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;movdqu (%%rsp), %%xmm14;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;add $16, %%rsp;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;cmp $0, %%r12;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;je block_%=;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;jmp *%2;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;block_%=:&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;ret;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    ::</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;i&quot;</span>(STACK_SIZE),</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;i&quot;</span>(handler),</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">&quot;m&quot;</span>(origin)</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>r12</code>和<code>r13</code> 寄存器是 <code>Golang</code> 中可以随意使用的临时寄存器，我们用 <code>r12</code> 来标识是否要阻断当前调用。而<code>r13</code> 用来参与计算，以确保调用 <code>handler</code> 时栈指针按 <code>16</code> 字节对齐，这是 <code>amd64</code> 下 <code>gcc</code> 的默认约定。<br>在代码的开头，我们先将 <code>X0</code> - <code>X14</code> 浮点数寄存器推入栈中，接着推入 <code>Golang</code> 1.17 以上需要使用的整数寄存器。然后调用 <code>z_malloc</code> 申请 40K 的内存替换当前栈，再以原始栈指针为参数调用 <code>handler</code>。在 <code>handler</code> 函数中，根据 <code>Golang</code> 的版本不同，我们可以从栈上存储的寄存器中，或上一函数的 <code>Stack frame</code> 中读出入参。当然也可以根据原始栈指针读取返回地址，从 <code>Golang</code> 符号表中查找函数信息，然后根据 <code>Stack frame</code> 读出上一层的返回地址，循环往复完成栈回溯。<br>我们甚至可以在 <code>handler</code> 中判断参数是否合法，当参数匹配到我们设置的正则时，可以手动写入 <code>error</code> 返回值到栈上，并返回 <code>false</code> 以将 <code>r12</code> 寄存器置零完成阻断。在 <code>handler</code> 函数执行完成后，从栈上恢复寄存器，并根据 <code>r12</code> 决定返回还是跳转至原函数。<br>为了更好地进行参数读取和阻断，我使用<code>Templates</code> 编写了一套 <code>Golang</code> 类型反射库，可以在运行时获取 <code>Golang</code> 类型元数据。元数据包含类型的基础类型成员数，每个成员的相对偏移以及占用大小，还有该类型需要占用的浮点/整数寄存器数。在 <code>handler</code> 函数中，我们可以轻松地利用这些元数据分析 <code>Golang</code> 的参数内存布局，正确地取出数据。由于该部分代码细节繁多，限于本文篇幅所以不进行详细讲解，取参与回溯部分请直接阅读<a target="_blank" rel="noopener" href="https://github.com/bytedance/Elkeid/tree/main/rasp/golang/go/api">仓库代码</a>。</p>
<h3 id="回溯停止"><a href="#回溯停止" class="headerlink" title="回溯停止"></a>回溯停止</h3><p>对于调用栈的回溯，上面已经解析过了，我们可以取出当前栈顶的返回地址，在符号表中查找地址相关的函数的名称、文件、行号以及栈帧大小。获取栈帧大小后，取出 <code>sp + framesize</code> 的上一层返回地址，循环上述步骤即可。但有一个问题是，我们在哪里结束循环？调用链的层数一定有限，那么第一个函数是哪个？<br>在 1.2 版本中，<code>Golang</code> 通过判断函数名是否为 <code>runtime.goexit</code>、<code>runtime.rt0_go</code> 等入口函数，由此决定是否终止回溯。而对于较新版本的 <code>Golang</code> ，符号信息中增加了一个 <code>funcID</code> 字段，通过 <code>funcID</code> 判断函数类型是否为入口函数。但 <code>funcID</code> 的本质与函数名比较无二，而且 <code>funcID</code> 在版本之间会发生变动，所以最后决定简单地使用函数名判断：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> STACK_TOP_FUNCTION = &#123;</span><br><span class="line">        <span class="string">&quot;runtime.mstart&quot;</span>,</span><br><span class="line">        <span class="string">&quot;runtime.rt0_go&quot;</span>,</span><br><span class="line">        <span class="string">&quot;runtime.mcall&quot;</span>,</span><br><span class="line">        <span class="string">&quot;runtime.morestack&quot;</span>,</span><br><span class="line">        <span class="string">&quot;runtime.lessstack&quot;</span>,</span><br><span class="line">        <span class="string">&quot;runtime.asmcgocall&quot;</span>,</span><br><span class="line">        <span class="string">&quot;runtime.externalthreadhandler&quot;</span>,</span><br><span class="line">        <span class="string">&quot;runtime.goexit&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="消息通信"><a href="#消息通信" class="headerlink" title="消息通信"></a>消息通信</h3><p>成功获取入参和调用栈后，要如何把消息传输出去？如果需要进行 <code>socket</code> 通信，并且不阻塞 <code>Golang</code> 线程，那就需要驻留一个线程在 <code>Golang</code> 进程内，实现一个简单的生产者消费者模型。那么在无法使用 <code>std::queue</code> 等标准库的情况下，要怎么实现消费丢列，又该如何保证线程安全？<br>为了尽可能地减少性能影响，我利用 <code>gcc</code> 内置的原子操作实现了一个定长的<a target="_blank" rel="noopener" href="https://github.com/Hackerl/zero/blob/master/include/zero/atomic/circular_buffer.h">无锁环形缓冲区</a>，并使用 <code>c-runtime</code> 中实现的 <code>condition variable</code> 做线程同步，实现了一个高效的消息队列。在每个钩子函数触发时，都会将入参和调用栈打包放入队列，如果队列已满则丢弃该消息。<br>在 <code>pangolin</code> 注入过程中，我们启动一个<a target="_blank" rel="noopener" href="https://github.com/bytedance/Elkeid/blob/main/rasp/golang/client/smith_probe.cpp#L40">消费者线程</a>，从消息队列中消费函数调用信息，序列化为 <code>json</code> 后通过 <code>unix socket</code> 传输到 <code>server</code>。</p>
<h3 id="信号屏蔽"><a href="#信号屏蔽" class="headerlink" title="信号屏蔽"></a>信号屏蔽</h3><p><code>Golang</code> 启动时会设置信号处理函数，而在进程收到信号时，内核会随机选择一个线程进行信号处理。我们在 <code>Golang</code> 进程中驻留的几个 <code>cpp</code> 线程有可能被选中用于执行处信号处理函数，但是处理函数默认当前处于 <code>Golang</code> 线程中，读取 <code>fs</code> 寄存器以访问 <code>Golang</code> 的全局 <code>G</code>，但此时 <code>fs</code> 所指向的其实是 <code>glibc</code> 的 <code>TLS</code>，于是导致异常退出。<br>为了避免这种情况发生，我们需要手动设置驻留的 <code>cpp</code> 线程，令其屏蔽所有信号：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sigset_t</span> mask = &#123;&#125;; </span><br><span class="line"><span class="keyword">sigset_t</span> origin_mask = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">sigfillset(&amp;mask);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pthread_sigmask(SIG_SETMASK, &amp;mask, &amp;origin_mask) != <span class="number">0</span>) &#123;</span><br><span class="line">    LOG_ERROR(<span class="string">&quot;set signal mask failed&quot;</span>);</span><br><span class="line">    quit(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p>在学习了原理和实现细节后，我们来解析一下 <code>go-probe</code> 的执行流程，<a target="_blank" rel="noopener" href="https://github.com/bytedance/Elkeid/blob/main/rasp/golang/main.cpp">入口函数</a>如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;go/symbol/build_info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;go/symbol/line_table.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;go/symbol/interface_table.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;go/api/api.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;zero/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;csignal&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/api_hook.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;z_syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">quit</span><span class="params">(<span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uintptr_t</span> address = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> *env = getenv(<span class="string">&quot;QUIT&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!env) &#123;</span><br><span class="line">        LOG_WARNING(<span class="string">&quot;can&#x27;t found quit env variable&quot;</span>);</span><br><span class="line">        z_exit_group(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!zero::strings::toNumber(env, address, <span class="number">16</span>) || !address) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;invalid quit function address&quot;</span>);</span><br><span class="line">        z_exit_group(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((<span class="keyword">decltype</span>(quit) *)address)(status);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    INIT_FILE_LOG(zero::INFO, <span class="string">&quot;go-probe&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sigset_t</span> mask = &#123;&#125;;</span><br><span class="line">    <span class="keyword">sigset_t</span> origin_mask = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    sigfillset(&amp;mask);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pthread_sigmask(SIG_SETMASK, &amp;mask, &amp;origin_mask) != <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;set signal mask failed&quot;</span>);</span><br><span class="line">        quit(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!gLineTable-&gt;load()) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;line table load failed&quot;</span>);</span><br><span class="line">        quit(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (gBuildInfo-&gt;load()) &#123;</span><br><span class="line">        LOG_INFO(<span class="string">&quot;go version: %s&quot;</span>, gBuildInfo-&gt;mVersion.c_str());</span><br><span class="line"></span><br><span class="line">        CInterfaceTable table = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!table.load()) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;interface table load failed&quot;</span>);</span><br><span class="line">            quit(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        table.findByFuncName(<span class="string">&quot;errors.(*errorString).Error&quot;</span>, (go::interface_item **)CAPIBase::errorInterface());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gSmithProbe-&gt;start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;api : GOLANG_API) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; gLineTable-&gt;mFuncNum; i++) &#123;</span><br><span class="line">            CFunc func = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!gLineTable-&gt;getFunc(i, func))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *name = func.getName();</span><br><span class="line">            <span class="keyword">void</span> *entry = (<span class="keyword">void</span> *)func.getEntry();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((api.ignoreCase ? strcasecmp(api.name, name) : <span class="built_in">strcmp</span>(api.name, name)) == <span class="number">0</span>) &#123;</span><br><span class="line">                LOG_INFO(<span class="string">&quot;hook %s: %p&quot;</span>, name, entry);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (hookAPI(entry, (<span class="keyword">void</span> *)api.metadata.entry, api.metadata.origin) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG_WARNING(<span class="string">&quot;hook %s failed&quot;</span>, name);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pthread_sigmask(SIG_SETMASK, &amp;origin_mask, <span class="literal">nullptr</span>);</span><br><span class="line">    quit(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要明确的是，<code>go-probe</code> 由 <code>pangolin</code> 注入到 <code>Golang</code> 进程的主线程中临时运行。同时 <code>pangolin</code> 使用 <code>ptrace</code> 持续监听该线程的 <code>syscall</code> 调用，拦截到 <code>main</code> 函数发出的 <code>exit</code> 或 <code>exit_group</code> 调用后，恢复线程状态并结束注入流程。然而可以看到，上面的代码中会优先调用环境变量 <code>QUIT</code> 指向的函数，这又是为何？<br>在实际的部署过程中，由于资源限制等诸多特殊原因，<code>pangolin</code> 进程可能会在注入期间被 <code>kill</code>。那么此时 <code>main</code> 函数执行的 <code>syscall</code> 就无人拦截，<code>exit_group</code> 会真正地导致业务进程退出。为了让执行 <code>go-probe</code> 的线程能够自我恢复，<code>pangolin</code> 会提前将线程状态快照写入到 <code>Golang</code> 内存中。同时遗留在 <code>Golang</code> 进程中的 <code>shellcode</code> 包含一个 <a target="_blank" rel="noopener" href="https://github.com/Hackerl/pangolin/blob/master/shellcode/loader/quit.c#L18">quit</a> 函数，能够根据该快照主动恢复线程，类似于 <code>glibc</code> 的 <code>setcontext</code>，而 <code>QUIT</code> 环境变量正是 <code>quit</code> 的地址。<br>在初始化文件日志后，先令当前线程屏蔽所有信号，之后启动的所有子线程都会继承该设置。然后从 <code>ELF</code> 的 <code>section</code> 中加载符号表、编译信息以及 <code>interface</code> 表，并且为了支持阻断功能，查找 <code>errors.(*errorString)</code> 的地址并保存。执行 <code>gSmithProbe-&gt;start()</code> 启动通信客户端后，从符号表中查找 <code>GOLANG_API</code> 所有子项，并进行 <code>Inline Hook</code>。完成以上流程后，恢复信号掩码并调用 <code>quit</code> 函数以通知 <code>pangolin</code> 结束注入。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hackerl.github.io/2022/02/28/Elkeid-Golang-RASP/" data-id="clogx15kd00019tt2hqv08q1q" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Node-js进程注入" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/13/Node-js%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5/" class="article-date">
  <time datetime="2021-02-13T13:04:58.000Z" itemprop="datePublished">2021-02-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/13/Node-js%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5/">Node.js进程注入</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上篇文章实现了对Python进程的代码注入，今天接着来尝试Node.js的注入。</p>
<h2 id="Inspector"><a href="#Inspector" class="headerlink" title="Inspector"></a>Inspector</h2><p>根据Node.js的<a target="_blank" rel="noopener" href="https://nodejs.org/en/docs/guides/debugging-getting-started/">官方文档</a>得知，在Node.js 8之后加入了新的调试机制(Inspector API)，在启动时加入”–inspect”参数或者向进程发送SIGUSR1信号，就会激活检查器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">kill</span> -USR1 $(pidof node)</span></span><br></pre></td></tr></table></figure>
<p>激活检查器后，终端会打印信息：</p>
<blockquote>
<p>Debugger listening on ws://127.0.0.1:9229/f1f12ee0-4f35-4e61-836c-71d175a607e3</p>
</blockquote>
<p>检查器监听本地端口9929，使用websocket协议，协议约定可见<a target="_blank" rel="noopener" href="https://chromedevtools.github.io/debugger-protocol-viewer/v8/">文档</a>，连接检查器可以使用node自带的inspect client：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node inspect -p $(pidof node)</span></span><br></pre></td></tr></table></figure>
<p>连接后可以通过”exec(‘console.log(123)’)”在目标进程中执行node代码，或者执行”repl”开启交互模式。但是自带的inspect client功能简单，如果需要更好的体验，可以使用chrome的调试模块，在chrome中访问”chrome://inspect”即可。</p>
<h2 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h2><p><a target="_blank" rel="noopener" href="https://github.com/nodejs/node-inspect">node-inspect</a>就是检查器客户端的官方代码仓库，通过阅读<a target="_blank" rel="noopener" href="https://github.com/nodejs/node-inspect/blob/master/lib/internal/inspect_client.js">inspect_client.js</a>发现，交互协议就是简单的json字符串，每个请求和响应通过id字段一一对应。<br>例如请求开启调试时，通过websocket协议发送字符串：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;method&quot;</span>: <span class="string">&quot;Debugger.enable&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>检查器返回响应：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;result&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;debuggerId&quot;</span>: <span class="string">&quot;(D750AD89818A150E3155AC1D6ECB7BB)&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你想在目标进程中执行代码，类似于”exec(‘console.log(123)’)”命令，你只需要使用<a target="_blank" rel="noopener" href="https://chromedevtools.github.io/devtools-protocol/tot/Runtime/#method-evaluate">Runtime.evaluate</a>，发送请求：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;method&quot;</span>: <span class="string">&quot;Runtime.evaluate&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;params&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;expression&quot;</span>: <span class="string">&quot;console.log(123)&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;includeCommandLineAPI&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数需要设置”includeCommandLineAPI”，否则注入的代码无法使用require函数。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hackerl.github.io/2021/02/13/Node-js%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5/" data-id="clogx15kf00069tt22sz1c9cn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Python进程注入" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/12/Python%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5/" class="article-date">
  <time datetime="2021-02-12T12:51:02.000Z" itemprop="datePublished">2021-02-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/12/Python%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5/">Python进程注入</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上篇文章讨论了Linux进程注入，能够在机器码层面进行代码注入，但如果现在有一个Python进程在运行，如何才让将Python代码注入进去呢？</p>
<h2 id="inject-by-gdb"><a href="#inject-by-gdb" class="headerlink" title="inject by gdb"></a>inject by gdb</h2><p>目前有两个项目能够对Python虚拟机进行注入，分别是<a target="_blank" rel="noopener" href="https://github.com/NtesEyes/pylane">pylane</a>以及<a target="_blank" rel="noopener" href="https://github.com/lmacken/pyrasite">pyrasite</a>。简单浏览两个项目，可以发现都是使用GDB在进程中进行<a target="_blank" rel="noopener" href="https://github.com/NtesEyes/pylane/blob/master/pylane/core/injector.py#L197">函数调用</a>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Injector</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_gdb_codes</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="comment"># use char in case of symbol PyGilState_STATE not found</span></span><br><span class="line">            <span class="string">&#x27;call $gil_state = (char) PyGILState_Ensure()&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;call (void) PyRun_SimpleString(&quot;%s&quot;)&#x27;</span> % prepare_code,</span><br><span class="line">            <span class="string">&#x27;call (void) PyRun_SimpleString(&quot;%s&quot;)&#x27;</span> % run_code,</span><br><span class="line">            <span class="string">&#x27;call (void) PyRun_SimpleString(&quot;%s&quot;)&#x27;</span> % cleanup_code,</span><br><span class="line">            <span class="comment"># make sure previous codes are safe.</span></span><br><span class="line">            <span class="comment"># gdb exit without GIL release is a disaster for target process.</span></span><br><span class="line">            <span class="string">&#x27;call (void) PyGILState_Release($gil_state)&#x27;</span>,</span><br><span class="line">        ]</span><br></pre></td></tr></table></figure>
<p>GDB附加到进程后，使用call命令在目标进程中依次调用函数PyGILState_Ensure、PyRun_SimpleString、PyGILState_Release就能在Python虚拟机中运行代码。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo gdb \</span><br><span class="line">  -p $pid \</span><br><span class="line">  -ex &#x27;call (int)PyGILState_Ensure()&#x27; \</span><br><span class="line">  -ex &#x27;call (int)PyRun_SimpleString(&quot;print(123)&quot;)&#x27;  \</span><br><span class="line">  -ex &#x27;call (int)PyGILState_Release($1)&#x27; \</span><br><span class="line">  -ex &#x27;set confirm off&#x27; \</span><br><span class="line">  -ex quit</span><br></pre></td></tr></table></figure>
<p>使用上诉命令，可以直接将”print(123)”注入到Python进程中。</p>
<h2 id="inject-by-pangolin"><a href="#inject-by-pangolin" class="headerlink" title="inject by pangolin"></a>inject by pangolin</h2><p>既然只需要在进程中调用三个函数，就可以完成Python代码注入，那么我们是否可以使用<a target="_blank" rel="noopener" href="https://github.com/Hackerl/pangolin">pangolin</a>将某个程序注入到进程中，完成这三个函数的调用。这也就是项目<a target="_blank" rel="noopener" href="https://github.com/Hackerl/python-inject">python-inject</a>的由来，它使用pangolin进行Python代码注入，不依赖于GDB。</p>
<h3 id="符号查找"><a href="#符号查找" class="headerlink" title="符号查找"></a>符号查找</h3><p>首先我们需要查找函数在目标进程中的地址，解析Python的ELF符号表，然后加上进程基址，代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;common/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;common/cmdline.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;common/utils/process.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;elfio/elfio.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*PFN_RUN)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *command)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*PFN_ENSURE)</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*PFN_RELEASE)</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> PYTHON = <span class="string">&quot;bin/python&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> PYTHON_LIBRARY = <span class="string">&quot;libpython&quot;</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> PYTHON_CALLER = <span class="string">&quot;python_caller&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> ** argv)</span> </span>&#123;</span><br><span class="line">    cmdline::parser parse;</span><br><span class="line"></span><br><span class="line">    parse.add&lt;<span class="keyword">int</span>&gt;(<span class="string">&quot;pid&quot;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&quot;pid&quot;</span>, <span class="literal">true</span>, <span class="number">0</span>);</span><br><span class="line">    parse.add&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;(<span class="string">&quot;source&quot;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&quot;python source file&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    parse.add&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;(<span class="string">&quot;pangolin&quot;</span>, <span class="string">&#x27;\0&#x27;</span>, <span class="string">&quot;pangolin path&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    parse.add(<span class="string">&quot;file&quot;</span>, <span class="string">&#x27;\0&#x27;</span>, <span class="string">&quot;pass source by file&quot;</span>);</span><br><span class="line"></span><br><span class="line">    parse.parse_check(argc, argv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pid = parse.get&lt;<span class="keyword">int</span>&gt;(<span class="string">&quot;pid&quot;</span>);</span><br><span class="line"></span><br><span class="line">    CProcessMap processMap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">            !CProcess::getFileMemoryBase(pid, PYTHON_LIBRARY, processMap) &amp;&amp;</span><br><span class="line">            !CProcess::getFileMemoryBase(pid, PYTHON, processMap)</span><br><span class="line">            ) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;find target failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LOG_INFO(<span class="string">&quot;find target: 0x%lx -&gt; %s&quot;</span>, processMap.start, processMap.file.c_str());</span><br><span class="line"></span><br><span class="line">    ELFIO::elfio reader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!reader.load(processMap.file)) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;open elf failed: %s&quot;</span>, processMap.file.c_str());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> it = <span class="built_in">std</span>::find_if(</span><br><span class="line">            reader.sections.begin(),</span><br><span class="line">            reader.sections.end(),</span><br><span class="line">            [](<span class="keyword">const</span> <span class="keyword">auto</span>&amp; s) &#123;</span><br><span class="line">                <span class="keyword">return</span> s-&gt;get_type() == SHT_DYNSYM;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (it == reader.sections.end()) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;can&#x27;t find symbol section&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> baseAddress = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (reader.get_type() != ET_EXEC) &#123;</span><br><span class="line">        <span class="keyword">auto</span> sit = <span class="built_in">std</span>::find_if(</span><br><span class="line">                reader.segments.begin(),</span><br><span class="line">                reader.segments.end(),</span><br><span class="line">                [](<span class="keyword">const</span> <span class="keyword">auto</span>&amp; s) &#123;</span><br><span class="line">                    <span class="keyword">return</span> s-&gt;get_type() == PT_LOAD;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sit == reader.segments.end()) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;can&#x27;t find load segment&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        baseAddress = processMap.start - (*sit)-&gt;get_virtual_address();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PFN_ENSURE pfnEnsure = <span class="literal">nullptr</span>;</span><br><span class="line">    PFN_RUN pfnRun = <span class="literal">nullptr</span>;</span><br><span class="line">    PFN_RELEASE pfnRelease = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ELFIO::symbol_section_accessor <span class="title">symbols</span><span class="params">(reader, *it)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ELFIO::Elf_Xword i = <span class="number">0</span>; i &lt; symbols.get_symbols_num(); i++) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> name;</span><br><span class="line">        ELFIO::Elf64_Addr value = <span class="number">0</span>;</span><br><span class="line">        ELFIO::Elf_Xword size = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> bind = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> type = <span class="number">0</span>;</span><br><span class="line">        ELFIO::Elf_Half section = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> other = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!symbols.get_symbol(i, name, value, size, bind, type, section, other)) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;get symbol %lu failed&quot;</span>, i);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name == <span class="string">&quot;PyGILState_Ensure&quot;</span>)</span><br><span class="line">            pfnEnsure = (PFN_ENSURE)(baseAddress + value);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (name == <span class="string">&quot;PyRun_SimpleString&quot;</span>)</span><br><span class="line">            pfnRun = (PFN_RUN)(baseAddress + value);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (name == <span class="string">&quot;PyGILState_Release&quot;</span>)</span><br><span class="line">            pfnRelease = (PFN_RELEASE)(baseAddress + value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pfnEnsure || !pfnRun || !pfnRelease) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;can&#x27;t find python symbols&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LOG_INFO(<span class="string">&quot;ensure func: %p run func: %p release func: %p&quot;</span>, pfnEnsure, pfnRun, pfnRelease);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> source = parse.get&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;(<span class="string">&quot;source&quot;</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> pangolin = parse.get&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;(<span class="string">&quot;pangolin&quot;</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> caller = CPath::join(CPath::getAPPDir(), PYTHON_CALLER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> callerCommand[<span class="number">1024</span>] = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(</span><br><span class="line">            callerCommand, <span class="keyword">sizeof</span>(callerCommand),</span><br><span class="line">            <span class="string">&quot;%s %s %d %p %p %p&quot;</span>,</span><br><span class="line">            caller.c_str(), source.c_str(), parse.exist(<span class="string">&quot;file&quot;</span>),</span><br><span class="line">            pfnEnsure, pfnRun, pfnRelease</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> err = execl(</span><br><span class="line">            pangolin.c_str(), pangolin.c_str(),</span><br><span class="line">            <span class="string">&quot;-c&quot;</span>, callerCommand,</span><br><span class="line">            <span class="string">&quot;-p&quot;</span>, <span class="built_in">std</span>::to_string(pid).c_str(),</span><br><span class="line">            <span class="literal">nullptr</span></span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;exec pangolin failed: %s&quot;</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h3><p>我们现在知道了函数在进程中的地址，只需要注入程序并传递地址参数，在进程中完成三个函数的调用，就可以实现Python代码注入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;crt_asm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;crt_log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;crt_utils.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*PFN_RUN)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *command)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*PFN_ENSURE)</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*PFN_RELEASE)</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> ** argv, <span class="keyword">char</span> ** env)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">6</span>) &#123;</span><br><span class="line">        LOG(<span class="string">&quot;usage: ./program source [0|1](source is file) address address address&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *source = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> is_file = !<span class="built_in">strcmp</span>(argv[<span class="number">2</span>], <span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    PFN_ENSURE pfn_ensure = (PFN_ENSURE)strtoul(argv[<span class="number">3</span>], <span class="literal">NULL</span>, <span class="number">16</span>);</span><br><span class="line">    PFN_RUN pfn_run = (PFN_RUN)strtoul(argv[<span class="number">4</span>], <span class="literal">NULL</span>, <span class="number">16</span>);</span><br><span class="line">    PFN_RELEASE pfn_release = (PFN_RELEASE)strtoul(argv[<span class="number">5</span>], <span class="literal">NULL</span>, <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pfn_ensure || !pfn_run || !pfn_release) &#123;</span><br><span class="line">        LOG(<span class="string">&quot;func address error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LOG(<span class="string">&quot;inject python source: %s flag: %d&quot;</span>, source, is_file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *code = source;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_file) &#123;</span><br><span class="line">        <span class="keyword">char</span> *buffer = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">long</span> length = read_file(source, &amp;buffer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            LOG(<span class="string">&quot;read file failed: %s&quot;</span>, source);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        code = <span class="built_in">malloc</span>(length + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!code) &#123;</span><br><span class="line">            LOG(<span class="string">&quot;malloc code memory failed&quot;</span>);</span><br><span class="line">            <span class="built_in">free</span>(buffer);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(code, <span class="number">0</span>, length + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(code, buffer, length);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(buffer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> state = pfn_ensure();</span><br><span class="line">    <span class="keyword">int</span> err = pfn_run(code);</span><br><span class="line">    pfn_release(state);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_file) &#123;</span><br><span class="line">        <span class="built_in">free</span>(code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> _main(<span class="keyword">unsigned</span> <span class="keyword">long</span> * sp) &#123;</span><br><span class="line">    <span class="keyword">int</span> argc = *sp;</span><br><span class="line">    <span class="keyword">char</span> **argv = (<span class="keyword">char</span> **)(sp + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">char</span> **env = argv + argc + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    __exit(main(argc, argv, env));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> _start() &#123;</span><br><span class="line">    CALL_SP(_main);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="fs寄存器"><a href="#fs寄存器" class="headerlink" title="fs寄存器"></a>fs寄存器</h2><p>也许你有疑问，为什么要将函数计算和调用分开，为什么不直接在目标进程中计算函数地址？实际上，我在项目刚开始的时候也是这样设计的，但是在测试过程中一直crash，经过调试发现这和fs寄存器相关。</p>
<h3 id="glibc"><a href="#glibc" class="headerlink" title="glibc"></a>glibc</h3><p>如果你使用C/C++编写了一个依赖于标准库的程序，那么程序加载时会先由glibc进行初始化，而在glibc中，每个线程初始化时都会修改fs寄存器指向一段私有的内存，用来存储线程局部变量等数据。<br>Python也会设置私有的fs寄存器，如果将一个依赖glibc的程序注入进去，那么程序运行时会修改fs寄存器。而此时调用Python的函数，就会导致crash，因为函数内部会访问fs寄存器，但此时的fs寄存器已经被修改了。<br>为了避免fs寄存器被修改，只能编写一个不依赖于标准库的程序(-nostdlib)，类似于我上面的代码，从程序入口点”_start”开始编写。不使用标准库进行符号解析以及地址计算，开发难度较大，所以权衡之下我选择将两者分离。</p>
<h3 id="arch-prctl"><a href="#arch-prctl" class="headerlink" title="arch_prctl"></a>arch_prctl</h3><p>使用arch_prctl系统调用可以修改fs寄存器，所以我尝试过一种解决方法，在函数调用之前临时将fs寄存器修改为原有值。所以我修改了pangolin，在进行注入时先获取当前fs寄存器值存入环境变量，在程序注入后根据环境变量恢复寄存器。<br>但是结果还是会导致crash，因为glibc的架构复杂，所以我没有继续深究，总之之后涉及fs寄存器的一切我都会敬而远之。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hackerl.github.io/2021/02/12/Python%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5/" data-id="clogx15kf00079tt262r06z6w" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Linux进程注入" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/11/Linux%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5/" class="article-date">
  <time datetime="2021-02-11T11:54:40.000Z" itemprop="datePublished">2021-02-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/11/Linux%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5/">Linux进程注入</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>将代码注入到特定进程空间内执行，是一种十分geek的行为，可用于破解、安全防护等。不像Windows有CreateRemoteThread可以直接在目标进程内创建线程，在Linux下进行进程注入会显得复杂些。<br>目前比较常用的手段，就是计算dlopen函数在libc.so中的位置，然后利用ptrace连接目标进程，更改PC地址使其运行该函数，但是该方式只能针对非静态编译的程序。</p>
<h2 id="mandibule"><a href="#mandibule" class="headerlink" title="mandibule"></a>mandibule</h2><p>我在github上发现了项目<a target="_blank" rel="noopener" href="https://github.com/ixty/mandibule">mandibule</a>，该项目不使用任何C标准库(-nostdlib)，类似于strcmp之类的函数都用C重写一遍，所以编译出来的产物就是一个无依赖shellcode。</p>
<h3 id="虚拟地址空间"><a href="#虚拟地址空间" class="headerlink" title="虚拟地址空间"></a>虚拟地址空间</h3><p>作者巧妙地使用编译器默认不进行函数排序的特点，在唯一的源文件mandibule.c开头编写函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">mandibule_beg</span><span class="params">(<span class="keyword">int</span> aligned)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!aligned)</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">long</span>)mandibule_beg;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">long</span>)mandibule_beg - ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)mandibule_beg % <span class="number">0x1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为项目只有这一个源文件，所以编译出来只有一个object文件，也就是说该函数会在程序代码段的最开头。在mandibule.c的末尾编写函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">mandibule_end</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint8_t</span> * p = (<span class="keyword">uint8_t</span>*)<span class="string">&quot;-= end_rodata =-&quot;</span>;</span><br><span class="line">    p += <span class="number">0x1000</span> - ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)p % <span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">long</span>)p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译后该函数当然会在代码段的末尾，作者编写这两个函数的目的是为了在该程序运行时，可以通过调用mandibule_beg(1)、mandibule_end获得该程序的虚拟地址范围。<br>一般来说ELF加载到内存中时，ELF头部之后就是TEXT代码段，又因为这些段是按页对齐的，所以调用mandibule_beg(1)返回自身函数地址向下对齐页，大概率获得ELF头部的虚拟地址，也就是程序虚拟空间的开始。<br>但是获取程序虚拟空间末尾地址却没这么简单，因为在TEXT段后面还有DATA、RODATA等数据段。mandibule_end内使用了一个用不到字符串，该字符串肯定会在RODATA中，所以使用该字符串地址向上对齐页能够获得末尾的虚拟地址。<br>根据这两个地址，我们可以确定程序运行所需的代码、数据地址空间，你甚至可以将该范围的数据全部拷贝到一个堆空间，更改页属性为可执行，然后直接跳转到入口点运行起来，当然，这需要你编译的代码是位置无关的(-PIC)。</p>
<h3 id="注入流程"><a href="#注入流程" class="headerlink" title="注入流程"></a>注入流程</h3><p>mandibule进行代码注入的步骤：</p>
<ul>
<li>使用ptrace附加到目标进程</li>
<li>备份进程寄存器、内存数据</li>
<li>将自身运行时地址空间内的所有数据拷贝到目标进程内</li>
<li>修改目标进程的寄存器，其实跳转到入口地址</li>
<li>等待目标进程调用exit系统调用</li>
<li>恢复寄存器、内存数据</li>
<li>恢复进程的运行</li>
</ul>
<p>第三步用到的地址范围就是mandibule_beg、mandibule_end所获得的，也相当于将程序自身拷贝到目标进程中运行。程序在目标进程中运行时，会使用一个自己编写ELF loader加载需要注入的代码。主要是使用mmap将程序段映射到进程空间，如果依赖动态库则还需要映射interpreter，最后生成一个假栈并设置好argv、env等信息，最后直接跳转到程序入口地址。</p>
<h3 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h3><p>使用mandibule可以对静态编译的程序进行注入，但是项目的设计有些缺陷：</p>
<ul>
<li>没有将shellcode与ptrace注入剥离，导致耦合严重</li>
<li>项目不使用C标准库，进行二次开发较为麻烦</li>
</ul>
<p>另外我在使用中发现了许多的bug，可见项目<a target="_blank" rel="noopener" href="https://github.com/ixty/mandibule/issues">issue</a>，我在推特上联系了作者，但他并没有要接着进行维护的意思。</p>
<h2 id="pangolin"><a href="#pangolin" class="headerlink" title="pangolin"></a>pangolin</h2><p>最后我决定对项目进行重构，将ELF loader编写成独立的shellcode模块，而ptrace注入部分完全可以用熟悉的C++开发。具体的代码细节不赘述，可以自行在github上查看<a target="_blank" rel="noopener" href="https://github.com/Hackerl/pangolin">项目</a>。</p>
<h3 id="链接脚本"><a href="#链接脚本" class="headerlink" title="链接脚本"></a>链接脚本</h3><p>在我的设计中，将shellcode部分编译成独立的so文件，然后根据导出符号的地址获取所有shellcode数据，将其写入目标进程中运行。但是在实现中遇到了问题，因为代码编译后不仅仅只有代码段，还包括RODATA等数据段，我们需要将所有数据都包括进来，而导出符号只会出现在TEXT中。<br>我知道在链接阶段可以指定所有符号的地址，让编译器根据我们的要求进行符号分段、排序。最后通过搜索学习，我编写了链接脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">    .text :</span><br><span class="line">    &#123;</span><br><span class="line">        *(.begin);</span><br><span class="line">        *(.text.*);</span><br><span class="line">        *(.rodata.*);</span><br><span class="line">        *(.end);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用该脚本进行链接，最后生成的程序只会有一个TEXT段，字符串等数据都会在该段中。另外我编写了三个导出函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __attribute__ ((section (<span class="string">&quot;.begin&quot;</span>))) shellcode_begin();</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shellcode_start</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">void</span> __attribute__ ((section (<span class="string">&quot;.end&quot;</span>))) shellcode_end();</span><br></pre></td></tr></table></figure>
<p>可以看到我指定了两个section分配给shellcode_begin、shellcode_end，也对应了链接脚本中的begin、end。所以最后生成的程序中，符号shellcode_begin会在TEXT段的最开始，shellcode_end在TEXT的末尾。<br>我们只需要将shellcode_begin至shellcode_end之间的数据拷贝到目标进程空间，然后跳转到shellcode_start - shellcode_begin的入口偏移处，就可以在进程中运行我们编写的shellcode。</p>
<h3 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h3><p>mandibule使用ptrace附加到进程主线程，此时别的线程依旧在运行中，在将数据拷贝到目标进程中时，覆盖的范围一般从ELF头部开始。如果覆盖的范围较大，就可能覆盖到代码段，而恰好此时其余的线程调用了一个被覆盖了的函数，就会导致程序崩溃。<br>为了减少多线程进程crash的可能性，我对内存覆盖进行了优化，先覆盖一小段shellcode，在目标进程中调用mmap系统调用申请内存，用申请的内存来储存较大的ELF loader。并且在ptrace阶段，会附加到所有线程，使其临时暂停运行。</p>
<h3 id="栈空间"><a href="#栈空间" class="headerlink" title="栈空间"></a>栈空间</h3><p>shellcode在目标进程中运行时，使用的是线程暂停时的栈，对于普通的程序，栈空间足够，所以不需要担心出现意外情况。但是对于golang这类自己管理栈的程序，栈空间十分小，shellcode在进程中运行时可能会溢出栈空间，覆盖掉程序数据最终导致crash。<br>另外，如果想在目标进程中驻留，可以在注入后创建新线程，但是在程序恢复运行后，新线程调用getenv等API运行会导致crash。因为argv、env等数据存在于我们注入时构建的栈上，但是该栈是别的线程拥有的，可能数据早已丢失。<br>为了解决这两个问题，我在ELF loader的开头使用mmap申请一块足够大的栈空间，并且修改SP寄存器更换栈空间。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loader_main</span><span class="params">(<span class="keyword">void</span> *ptr)</span> </span>&#123;</span><br><span class="line">    LOG(<span class="string">&quot;elf loader start&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *<span class="built_in">stack</span> = <span class="built_in">malloc</span>(STACK_SIZE);</span><br><span class="line">    <span class="keyword">char</span> *stack_top = <span class="built_in">stack</span> + STACK_SIZE;</span><br><span class="line"></span><br><span class="line">    FIX_SP_JMP(stack_top, elf_loader, ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还有许多的小细节，都存在于代码中，如果感兴趣可以自行阅读。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hackerl.github.io/2021/02/11/Linux%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5/" data-id="clogx15ke00029tt2cptr6rfs" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-flutter逆向工程一" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/15/flutter%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E4%B8%80/" class="article-date">
  <time datetime="2020-10-15T10:48:29.000Z" itemprop="datePublished">2020-10-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/15/flutter%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E4%B8%80/">flutter逆向工程一</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>几个星期前, 出于某些原因我想逆向某个APK文件, 和平常一样, 我使用apktool/dex2jar/jd-gui三件套开始工作. 出乎意料的是, 我没有在classes.dex里面找到任何程序相关的逻辑, 取而代之的是一些”flutter”的代码段.</p>
<h2 id="初探"><a href="#初探" class="headerlink" title="初探"></a>初探</h2><p>flutter是谷歌开发的跨平台框架, 初略的探索之后, 我得知程序的逻辑都存在于”libapp.so”文件中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜ tree lib</span><br><span class="line">lib</span><br><span class="line">├── arm64-v8a</span><br><span class="line">│   ├── libapp.so</span><br><span class="line">│   └── libflutter.so</span><br><span class="line">├── armeabi-v7a</span><br><span class="line">│   ├── libapp.so</span><br><span class="line">│   └── libflutter.so</span><br><span class="line">└── x86_64</span><br><span class="line">    ├── libapp.so</span><br><span class="line">    └── libflutter.so</span><br><span class="line"></span><br><span class="line">3 directories, 6 files</span><br></pre></td></tr></table></figure>
<p>APK解开后, lib目录下面会有两个库文件, “libflutter.so”是框架的运行时支持, “libapp.so”则是逻辑层编译而成的产物.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜ readelf --symbols --wide libapp.so</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.dynsym&#x27; contains 6 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 00001000    12 FUNC    GLOBAL DEFAULT    1 _kDartBSSData</span><br><span class="line">     2: 00002000  9616 FUNC    GLOBAL DEFAULT    2 _kDartVmSnapshotInstructions</span><br><span class="line">     3: 00005000 24400 FUNC    GLOBAL DEFAULT    3 _kDartVmSnapshotData</span><br><span class="line">     4: 0000b000 0x1edf30 FUNC    GLOBAL DEFAULT    4 _kDartIsolateSnapshotInstructions</span><br><span class="line">     5: 001f9000 0x175bb0 FUNC    GLOBAL DEFAULT    5 _kDartIsolateSnapshotData</span><br></pre></td></tr></table></figure>
<p>查看导出符号, 只有上面四个, 但从名称上分析并不像函数. 接下来开始使用IDA分析:<br><img src="https://i.imgur.com/eycadrY.png"><br>符号”_kDartVmSnapshotData”看起来的确不像是导出函数, 更像是序列化之后的数据, 应该是提供给dart虚拟机解释执行的.</p>
<h2 id="探索"><a href="#探索" class="headerlink" title="探索"></a>探索</h2><p>我搜索了很久, 几乎没有关于flutter逆向相关的文章, 只有<a target="_blank" rel="noopener" href="https://blog.tst.sh/reverse-engineering-flutter-apps-part-1/#anatomy-of-a-snapshot">reverse-engineering-flutter-apps-part-1</a>这篇文章进行了剖析.</p>
<h3 id="快照"><a href="#快照" class="headerlink" title="快照"></a>快照</h3><p>“libapp.so”实际上是dart编译生成的快照文件, 这种快照格式称为”AOT”, 上面提到的四个导出符号就是快照数据的起始偏移:</p>
<ul>
<li>“_kDartVmSnapshotData”: 虚拟机运行所需的Object等相关数据</li>
<li>“_kDartVmSnapshotInstructions”: 虚拟机运行所需指令相关数据</li>
<li>“_kDartIsolateSnapshotData”: 逻辑层运行所需的Object等相关数据</li>
<li>“_kDartIsolateSnapshotInstructions”: 逻辑层运行所需指令相关数据</li>
</ul>
<p>官方没有文档公布快照AOT快照的数据格式, 不过幸好flutter和dart都是开源的, 我们可以调试AOT生成/加载的全过程, 就能知道快照里存了什么数据, 在逆向过程中又能如何利用这些数据.</p>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>文章中提到了如何单纯的将dart文件转变成”libapp.so”:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/flutter/bin/cache/dart-sdk/bin/dart ~/flutter/bin/cache/artifacts/engine/linux-x64/frontend_server.dart.snapshot --sdk-root ~/flutter/bin/cache/artifacts/engine/common/flutter_patched_sdk_product/ --strong --target=flutter --aot --tfa -Ddart.vm.product=true --output-dill app.dill main.dart</span><br><span class="line">gen_snapshot --causal_async_stacks --deterministic --snapshot_kind=app-aot-elf --elf=libapp.so --strip app.dill</span><br></pre></td></tr></table></figure>
<p>上面使用的是flutter sdk中包含的dart相关工具, 我测试之后发现只需要dart sdk就可以完成AOT的生成. 那么接下来, 我们需要编译一个带有调试信息的dart sdk:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> dev tool</span></span><br><span class="line">git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br><span class="line">export PATH=&quot;$PATH:$PWD/depot_tools&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> fetch <span class="built_in">source</span></span></span><br><span class="line">mkdir dart-sdk; cd dart-sdk</span><br><span class="line">fetch dart</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> build</span></span><br><span class="line">cd sdk</span><br><span class="line">./tools/build.py -m debug --no-goma -a x64 --debug-opt-level 0 all</span><br></pre></td></tr></table></figure>
<p>查看编译生成的产物:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">➜ tree -L 1</span><br><span class="line">.</span><br><span class="line">├──  -</span><br><span class="line">├── app.dill</span><br><span class="line">├── args.gn</span><br><span class="line">├── build.ninja</span><br><span class="line">├── build.ninja.d</span><br><span class="line">├── compressed_observatory_archive.tar</span><br><span class="line">├── dart</span><br><span class="line">├── dart2js_nnbd_strong_outline.dill</span><br><span class="line">├── dart2js_nnbd_strong_platform.dill</span><br><span class="line">├── dart2js_nnbd_strong_platform.dill.d</span><br><span class="line">├── dart2js_outline.dill</span><br><span class="line">├── dart2js_platform.dill</span><br><span class="line">├── dart2js_platform.dill.d</span><br><span class="line">├── dart2js_server_nnbd_strong_outline.dill</span><br><span class="line">├── dart2js_server_nnbd_strong_platform.dill</span><br><span class="line">├── dart2js_server_nnbd_strong_platform.dill.d</span><br><span class="line">├── dart2js_server_outline.dill</span><br><span class="line">├── dart2js_server_platform.dill</span><br><span class="line">├── dart2js_server_platform.dill.d</span><br><span class="line">├── dartdevc.dill</span><br><span class="line">├── dartdevc.js</span><br><span class="line">├── dartdevc.js.map</span><br><span class="line">├── dartdev.dill</span><br><span class="line">├── dart_precompiled_runtime</span><br><span class="line">├── dart_precompiled_runtime_product</span><br><span class="line">├── dart-sdk</span><br><span class="line">├── ddc_outline.dill</span><br><span class="line">├── ddc_outline_sound.dill</span><br><span class="line">├── ddc_platform.dill</span><br><span class="line">├── ddc_platform.dill.d</span><br><span class="line">├── ddc_platform_sound.dill</span><br><span class="line">├── ddc_platform_sound.dill.d</span><br><span class="line">├── dds.dart.snapshot</span><br><span class="line">├── dev_compiler</span><br><span class="line">├── exe.stripped</span><br><span class="line">├── gen</span><br><span class="line">├── gen_kernel_bytecode.dill</span><br><span class="line">├── gen_snapshot</span><br><span class="line">├── gen_snapshot_fuchsia</span><br><span class="line">├── gen_snapshot_host_targeting_host</span><br><span class="line">├── gen_snapshot_product</span><br><span class="line">├── gen_snapshot_product_fuchsia</span><br><span class="line">├── gen_snapshot_product_host_targeting_host</span><br><span class="line">├── icudtl.dat</span><br><span class="line">├── icudtl_extra.dat</span><br><span class="line">├── kernel-service.dart.snapshot</span><br><span class="line">├── libapp.so</span><br><span class="line">├── libentrypoints_verification_test_extension.so</span><br><span class="line">├── libentrypoints_verification_test_extension.so.TOC</span><br><span class="line">├── libffi_test_dynamic_library.so</span><br><span class="line">├── libffi_test_dynamic_library.so.TOC</span><br><span class="line">├── libffi_test_functions.so</span><br><span class="line">├── libffi_test_functions.so.TOC</span><br><span class="line">├── libsample_extension.so</span><br><span class="line">├── libsample_extension.so.TOC</span><br><span class="line">├── libtest_extension.so</span><br><span class="line">├── libtest_extension.so.TOC</span><br><span class="line">├── obj</span><br><span class="line">├── observatory_archive.tar</span><br><span class="line">├── offsets_extractor</span><br><span class="line">├── offsets_extractor_precompiled_runtime</span><br><span class="line">├── out.js</span><br><span class="line">├── out.js.deps</span><br><span class="line">├── out.js.map</span><br><span class="line">├── process_test</span><br><span class="line">├── run_vm_tests</span><br><span class="line">├── toolchain.ninja</span><br><span class="line">├── vm_outline_strong.dill</span><br><span class="line">├── vm_outline_strong_product.dill</span><br><span class="line">├── vm_outline_strong_stripped.dill</span><br><span class="line">├── vm_platform_strong.dill</span><br><span class="line">├── vm_platform_strong.dill.d</span><br><span class="line">├── vm_platform_strong.dill.S</span><br><span class="line">├── vm_platform_strong_product.dill</span><br><span class="line">├── vm_platform_strong_product.dill.d</span><br><span class="line">├── vm_platform_strong_stripped.dill</span><br><span class="line">├── vm_platform_strong_stripped.dill.d</span><br><span class="line">└── zlib_bench</span><br><span class="line"></span><br><span class="line">5 directories, 73 files</span><br></pre></td></tr></table></figure>
<p>dart-sdk子目录就和我们在官网下载到的版本一样, 但是它里面的程序符号表已被去除, 我们无法基于源码调试, 我们只能使用顶层那些散乱的产物. 根据<a target="_blank" rel="noopener" href="https://dart.dev/tools/dart2native">官网</a>的描述, 使用dart2native就能生成AOT快照:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dart2native bin/main.dart -k aot</span><br></pre></td></tr></table></figure>
<p>在我们的目标产物中, 查看dart2native内容, 发现它只是个脚本文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env bash</span><br><span class="line"># Copyright (c) 2019, the Dart project authors.  Please see the AUTHORS file</span><br><span class="line"># for details. All rights reserved. Use of this source code is governed by a</span><br><span class="line"># BSD-style license that can be found in the LICENSE file.</span><br><span class="line"></span><br><span class="line"># Run dart2native.dart.snapshot on the Dart VM</span><br><span class="line"></span><br><span class="line">function follow_links() &#123;</span><br><span class="line">  file&#x3D;&quot;$1&quot;</span><br><span class="line">  while [ -h &quot;$file&quot; ]; do</span><br><span class="line">    # On Mac OS, readlink -f doesn&#39;t work.</span><br><span class="line">    file&#x3D;&quot;$(readlink &quot;$file&quot;)&quot;</span><br><span class="line">  done</span><br><span class="line">  echo &quot;$file&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Unlike $0, $BASH_SOURCE points to the absolute path of this file.</span><br><span class="line">PROG_NAME&#x3D;&quot;$(follow_links &quot;$BASH_SOURCE&quot;)&quot;</span><br><span class="line"></span><br><span class="line"># Handle the case where dart-sdk&#x2F;bin has been symlinked to.</span><br><span class="line">BIN_DIR&#x3D;&quot;$(cd &quot;$&#123;PROG_NAME%&#x2F;*&#125;&quot; ; pwd -P)&quot;</span><br><span class="line">SNAPSHOTS_DIR&#x3D;&quot;$&#123;BIN_DIR&#125;&#x2F;snapshots&quot;</span><br><span class="line">DART&#x3D;&quot;$BIN_DIR&#x2F;dart&quot;</span><br><span class="line"></span><br><span class="line">exec &quot;$DART&quot; &quot;$&#123;SNAPSHOTS_DIR&#125;&#x2F;dart2native.dart.snapshot&quot; $*</span><br></pre></td></tr></table></figure>
<p>脚本使用dart执行dart2native.dart.snapshot, 说明dart2native.dart.snapshot是由dart编写而成的, 具体的源码可以查看<a target="_blank" rel="noopener" href="https://github.com/dart-lang/sdk/tree/master/pkg/dart2native">github仓库</a>. 通过阅读<a target="_blank" rel="noopener" href="https://github.com/dart-lang/sdk/blob/master/pkg/dart2native/lib/generate.dart#L69">源码</a>, 发现它其实是通过调用gen_snapshot进行的快照生成:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">final String kernelFile &#x3D; path.join(tempDir.path, &#39;kernel.dill&#39;);</span><br><span class="line">final kernelResult &#x3D; await generateAotKernel(Platform.executable, genKernel,</span><br><span class="line">    productPlatformDill, sourcePath, kernelFile, packages, defines,</span><br><span class="line">    enableExperiment: enableExperiment);</span><br><span class="line">if (kernelResult.exitCode !&#x3D; 0) &#123;</span><br><span class="line">  stderr.writeln(kernelResult.stdout);</span><br><span class="line">  stderr.writeln(kernelResult.stderr);</span><br><span class="line">  await stderr.flush();</span><br><span class="line">  throw &#39;Generating AOT kernel dill failed!&#39;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (verbose) &#123;</span><br><span class="line">  print(&#39;Generating AOT snapshot.&#39;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">final String snapshotFile &#x3D; (outputKind &#x3D;&#x3D; Kind.aot</span><br><span class="line">    ? outputPath</span><br><span class="line">    : path.join(tempDir.path, &#39;snapshot.aot&#39;));</span><br><span class="line">final snapshotResult &#x3D; await generateAotSnapshot(genSnapshot, kernelFile,</span><br><span class="line">    snapshotFile, debugPath, enableAsserts, extraOptions);</span><br><span class="line">if (snapshotResult.exitCode !&#x3D; 0) &#123;</span><br><span class="line">  stderr.writeln(snapshotResult.stdout);</span><br><span class="line">  stderr.writeln(snapshotResult.stderr);</span><br><span class="line">  await stderr.flush();</span><br><span class="line">  throw &#39;Generating AOT snapshot failed!&#39;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先使用dart生成kernel.dill, 然后使用gen_snapshot将kernel.dill转成AOT, 这也与文章中提到的方法一致.</p>
<h3 id="生成"><a href="#生成" class="headerlink" title="生成"></a>生成</h3><p>进入dart-sdk子目录, 编辑hello.dart:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">void main() &#123;</span><br><span class="line">  print(&#39;Hello, World!&#39;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着生成kernel.dill:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/dart bin/snapshots/gen_kernel.dart.snapshot --platform lib/_internal/vm_platform_strong_product.dill --aot -Ddart.vm.product=true -o kernel.dill hello.dart</span><br></pre></td></tr></table></figure>
<p>使用gen_snapshot生成AOT快照:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/utils/gen_snapshot --snapshot_kind=app-aot-elf --elf=libapp.so kernel.dill</span><br></pre></td></tr></table></figure>
<p>经历重重关卡, 我们成功将dart源码转成了AOT快照, 那么接下来, 我们只需要使用gdb一步步跟踪快照的生成.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hackerl.github.io/2020/10/15/flutter%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E4%B8%80/" data-id="clogx15kf00089tt2hznfbuc4" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-软路由折腾记录三" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/21/%E8%BD%AF%E8%B7%AF%E7%94%B1%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95%E4%B8%89/" class="article-date">
  <time datetime="2020-09-21T02:39:35.000Z" itemprop="datePublished">2020-09-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/21/%E8%BD%AF%E8%B7%AF%E7%94%B1%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95%E4%B8%89/">软路由折腾记录三</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ADGuard"><a href="#ADGuard" class="headerlink" title="ADGuard"></a>ADGuard</h2><p>在路由器层面进行广告过滤, 并没有特别有效的方法, 到目前为止最有效的依旧是浏览器插件. 因为广告过滤的核心是拦截js/图片, 路由器上的透明代理很难窥视HTTPS传输的内容, 所以目前的路由器插件仅能对HTTP进行过滤. ADGuard Home另辟蹊径, 它提供DNS服务, 对黑名单里的广告域名进行拦截, 返回一个无法访问的IP.</p>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>由于clash提供了DNS服务, 所以需要调整ADGuard/clash的上下游顺序.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnsmasq -&gt; ADGuard -&gt; clash</span><br></pre></td></tr></table></figure>
<p>首先启动ADGuard:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name adguardhome -v /my/own/workdir:/opt/adguardhome/work -v /my/own/confdir:/opt/adguardhome/conf -p 5301:53/tcp -p 5301:53/udp -p 3000:3000/tcp -d adguard/adguardhome</span><br></pre></td></tr></table></figure>
<p>ADGuard的DNS服务监听5031端口, 而clash监听5300端口. 首先编辑dnsmasq配置文件, 设置上游服务器为ADGuard:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server=127.0.0.1#5301</span><br></pre></td></tr></table></figure>
<p>接着访问软路由3000端口, 这是ADGuard提供的web界面, 在里面配置上游DNS为5300. 接下来就可以自有配置过滤规则, 配置完后可以执行命令验证广告域名是否被屏蔽:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig ad.xxx.xxx</span><br></pre></td></tr></table></figure>
<h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p>由于广告推送技术的发展, 现在光屏蔽域名还远远不够. 实测效果来看, 国内各大视频网站的广告均无法过滤, 而类似于谷歌联盟的图片广告可以屏蔽. 另外ADGuard不仅仅用于广告过滤, 还能屏蔽一些统计js, 针对斗鱼/虎牙等还能屏蔽p2p通信, 这些都需要在web界面里勾选一些开源规则.<br>但需要注意, 屏蔽某些域名可能导致网站体验不佳, 例如禁用p2p后斗鱼/虎牙会偶尔卡顿.</p>
<h2 id="ipset"><a href="#ipset" class="headerlink" title="ipset"></a>ipset</h2><p>在使用了tproxy透明代理UDP流量后, 所有TCP/UDP流量均由clash处理, 包括与大陆ip的通信. 由于UDP转发本身比较耗费CPU, 所以我考虑能不能让大陆ip直接在iptables层放行, 只有国外ip的流量会通过clash.<br>ipset是iptables提供的工具, 你可以给一组ip取一个名称, 然后在iptables规则中检测目标ip是否属于该组. 所以我们只需要把大陆的ip网段添加到一个组中, 取名为”china”, 接着新建规则, 如果ip属于”china”则不进行透明代理.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://www.ipdeny.com/ipblocks/data/countries/cn.zone</span><br><span class="line"></span><br><span class="line">ipset -N china hash:net</span><br><span class="line">for i in $(cat ./cn.zone ); do</span><br><span class="line">    ipset -A china $i;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>接着在iptables相应的表中添加规则:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t mangle -A CLASH -p udp -m set --match-set china dst -j RETURN</span><br><span class="line">iptables -t nat -A CLASH -p tcp -m set --match-set china dst -j RETURN</span><br></pre></td></tr></table></figure>
<p>配置完成后, 只有国外ip的访问会经过clash, 而大陆ip的访问由iptables直接转发.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hackerl.github.io/2020/09/21/%E8%BD%AF%E8%B7%AF%E7%94%B1%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95%E4%B8%89/" data-id="clogx15kg000d9tt2bnjn4b55" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-软路由折腾记录二" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/11/%E8%BD%AF%E8%B7%AF%E7%94%B1%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95%E4%BA%8C/" class="article-date">
  <time datetime="2020-09-11T14:54:03.000Z" itemprop="datePublished">2020-09-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/11/%E8%BD%AF%E8%B7%AF%E7%94%B1%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95%E4%BA%8C/">软路由折腾记录二</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我从大二开始接触linux, 最开始安装的就是基于debian的kali, 之后直接将debian作为主系统日常使用. 包括现在购买的VPS, 又或是wsl都安装的debian, 就如同我对firefox一样, 产生了深厚的感情.</p>
<h2 id="改造"><a href="#改造" class="headerlink" title="改造"></a>改造</h2><p>接上篇文章, 历经千幸万苦终于可以在OpenWrt上运行Docker后, tproxy透明代理失效了. 因为OpenWrt系统十分精简, 再加上是我自己编译的版本, 缺少官方的软件源, 所以调试变得异常困难. 最终我不得不放弃, 转向debian. 我熟练地下载官方镜像, 使用rufus写入U盘, 按部就班的完成了系统安装.<br>那么接下来就需要将它改造成路由器.</p>
<h3 id="网桥"><a href="#网桥" class="headerlink" title="网桥"></a>网桥</h3><p>我的主机有4个网口, 我将第一个网口当做WAN, 连接着联通光猫. 那么我需要将剩下三个网口进行桥接, 使它们处于一个网段, 当为LAN口使用.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">apt install bridge-utils</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加桥接网卡</span></span><br><span class="line">brctl addbr br0</span><br><span class="line">brctl addif br0 enp0s8 enp0s9</span><br></pre></td></tr></table></figure>
<p>你可以选择使用brctl手动添加桥接网卡, 但是重启之后会消失, 所以建议写入网络配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;etc&#x2F;network&#x2F;interfaces</span><br><span class="line">auto br0</span><br><span class="line">iface br0 inet static</span><br><span class="line">    address 192.168.12.1</span><br><span class="line">    broadcast 192.168.12.255</span><br><span class="line">    netmask 255.255.255.0</span><br><span class="line">    bridge-ports enp0s8 enp0s9</span><br></pre></td></tr></table></figure>
<p>bridge-ports参数替换成具体的网卡, 上面的例子只桥接了两个网卡, 这并不是我实际使用的配置, 仅供参考.</p>
<h3 id="DNS-DHCP"><a href="#DNS-DHCP" class="headerlink" title="DNS/DHCP"></a>DNS/DHCP</h3><p>路由器最重要的自然是DHCP/DNS, 而dnsmasq帮我们轻松搞定:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install dnsmasq</span><br></pre></td></tr></table></figure>
<p>dnsmasq会提供DHCP/DNS服务, DNS默认转发到上游DNS, 暂时不需要修改, 但是DHCP需要修改配置文件指定网段等信息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;etc&#x2F;dnsmasq.conf</span><br><span class="line">interface&#x3D;br0</span><br><span class="line">dhcp-range&#x3D;192.168.12.100,192.168.12.250,72h</span><br></pre></td></tr></table></figure>
<h3 id="转发"><a href="#转发" class="headerlink" title="转发"></a>转发</h3><p>现在将电脑网线插入J1900主机网口, 电脑可以使用DHCP获取到IP, 可惜现在还上不了网. 因为linux默认将目标IP不是本机的流量全部DROP, 首先打开IP转发:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 重启后失效</span></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure>
<p>光开启转发还是无法上网, 因为内网网段访问外网需要NAT, 所以需要配置iptables:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 192.168.12.0/24 -o enp0s3 -j MASQUERADE</span><br></pre></td></tr></table></figure>
<p>enp0s3是WAN口网卡, MASQUERADE将把子网流量自动NAT转换, 现在你可以自由的进行网上冲浪了.</p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p>完成上面一切, debian现在与OpenWrt有着同样的功能, 而且还废弃了那些累赘的组件. 我现在准备安装docker-ce, 过程很迅速, 安装完后我开始基于docker-ce搭建自己的SMB服务.<br>一切都完成了, 我长舒一口气, 我在终端执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig google.com @8.8.8.8</span><br></pre></td></tr></table></figure>
<p>命令卡住了!!! tproxy又罢工了!!! 我突然意识到我错怪了OpenWrt, 这似乎是Docker惹的祸, 于是我又开始了漫长的debug.</p>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><h3 id="网络架构"><a href="#网络架构" class="headerlink" title="网络架构"></a>网络架构</h3><p><img src="https://i.imgur.com/COQcWrd.jpg"><br>这张图显示的是linux的网络架构, 包括iptables的链条顺序、路由选择, 下面所有的调试都是基于这张图.</p>
<h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><p>我知道Docker的网络建立在iptables上, 它一样使用虚拟桥接网卡连接各个容器, 然后在iptables添加规则进行NAT. 可是没理由它会影响到主机的网络, 我一条一条地查看Docker添加的防火墙规则, 唯一异常的点是它将filter表的FORWARD默认策略改成了DROP. 但tproxy压根不会经过FORWARD, 路由规则会让流量进入本地协议栈.<br>根据架构图可以知道, 如果包进入了filter表的INPUT链, 那么说明流量已经过了路由选择, 即将进入本地协议栈. 如果tproxy正常工作, 修改了包的结构体, 那么此时代理端口与包是相关联的, 所以包会被正常接收.<br>我开始猜测tproxy没有正常运作, 导致路由失败, 包被FORWARD出去了:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -I INPUT 1 -p udp -j LOG --log-prefix &#x27;** SUSPECT filter INPUT**&#x27;</span><br></pre></td></tr></table></figure>
<p>我添加了一条iptables规则, 当匹配到包时会打印出日志, 于是我重复了一次DNS查询操作. 日志出现了, 所以我断定它已经走过了路由选择. 我又接着猜测了几种可能:</p>
<ul>
<li>tproxy关联包信息失败</li>
<li>IP_TRANSPARENT属性失效</li>
</ul>
<p>这两种情况我都没有有效的测试手段, 所以我陷入了困境, 不过我觉得原因大概率是docker-ce加载了某个内核模块. 于是我使用dpkg查看所有安装的包, 只发现了一个aufs.ko, 貌似不是很符合.<br>当我束手无策时, 我发现了这篇帖子<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/57710177/tproxy-compatibility-with-docker">TPROXY compatibility with Docker</a>.<br>作者遇到了和我一样的问题, 于是它使用strace跟踪dockerd的系统调用, 发现它加载了一个内核模块”br_netfilter”. 我不抱任何希望的执行了”rmmod br_netfilter”, 它恢复了!!! 原来是这个br_netfilter的问题!!!</p>
<h3 id="ebtables"><a href="#ebtables" class="headerlink" title="ebtables"></a>ebtables</h3><p>这时我才仔细去观察上面的架构图, 我发现我遗漏了一个问题, 就是网桥的流量会走Link Layer, 所以可能是这部分出了问题. 图中的蓝色表代表的是ebtables, 绿色表代表iptables, ebtables可以理解成链路的iptables.<br>我想弄清楚流量的具体走向, 所以我在每个点都加上log规则, 数据包的流向将一览无遗:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> raw</span></span><br><span class="line">iptables -t raw -I PREROUTING 1 -p udp -j LOG --log-prefix &#x27;** SUSPECT raw PREROUTING**&#x27;</span><br><span class="line">iptables -t raw -I OUTPUT 1 -p udp -j LOG --log-prefix &#x27;** SUSPECT raw OUTPUT**&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> mangle</span></span><br><span class="line">iptables -t mangle -I PREROUTING 1 -p udp -j LOG --log-prefix &#x27;** SUSPECT mangle PREROUTING**&#x27;</span><br><span class="line">iptables -t mangle -I INPUT 1 -p udp -j LOG --log-prefix &#x27;** SUSPECT mangle INPUT**&#x27;</span><br><span class="line">iptables -t mangle -I FORWARD 1 -p udp -j LOG --log-prefix &#x27;** SUSPECT mangle FORWARD**&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> nat</span></span><br><span class="line">iptables -t nat -I PREROUTING 1 -p udp -j LOG --log-prefix &#x27;** SUSPECT nat PREROUTING**&#x27;</span><br><span class="line">iptables -t nat -I INPUT 1 -p udp -j LOG --log-prefix &#x27;** SUSPECT nat INPUT**&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> filter</span></span><br><span class="line">iptables -t filter -I INPUT 1 -p udp -j LOG --log-prefix &#x27;** SUSPECT filter INPUT**&#x27;</span><br><span class="line">iptables -t filter -I FORWARD 1 -p udp -j LOG --log-prefix &#x27;** SUSPECT filter FORWARD**&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> BROUTING</span></span><br><span class="line">ebtables-legacy -t broute -A BROUTING -p ipv4 --ip-proto udp --log-level 6 --log-ip --log-prefix &quot;TRACE: eb:broute:BROUTING&quot; -j CONTINUE</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> nat</span></span><br><span class="line">ebtables-legacy -t nat -A OUTPUT -p ipv4 --ip-proto udp --log-level 6 --log-ip --log-prefix &quot;TRACE: eb:nat:OUTPUT&quot;  -j CONTINUE</span><br><span class="line">ebtables-legacy -t nat -A PREROUTING -p ipv4 --ip-proto udp --log-level 6 --log-ip --log-prefix &quot;TRACE: eb:nat:PREROUTING&quot; -j CONTINUE</span><br><span class="line">ebtables-legacy -t nat -A POSTROUTING -p ipv4 --ip-proto udp --log-level 6 --log-ip --log-prefix &quot;TRACE: eb:nat:POSTROUTING&quot; -j CONTINUE</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> filter</span></span><br><span class="line">ebtables-legacy -t filter -A INPUT -p ipv4 --ip-proto udp --log-level 6 --log-ip --log-prefix &quot;TRACE: eb:filter:INPUT&quot; -j CONTINUE</span><br><span class="line">ebtables-legacy -t filter -A FORWARD -p ipv4 --ip-proto udp --log-level 6 --log-ip --log-prefix &quot;TRACE: eb:filter:FORWARD&quot; -j CONTINUE</span><br><span class="line">ebtables-legacy -t filter -A OUTPUT -p ipv4 --ip-proto udp --log-level 6 --log-ip --log-prefix &quot;TRACE: eb:filter:OUTPUT&quot; -j CONTINUE</span><br></pre></td></tr></table></figure>
<p>在未加载br_netfilter的情况下, 我向8.8.8.8查询域名:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">TRACE: eb:broute:BROUTING IN&#x3D;enp0s8 OUT&#x3D; MAC source &#x3D; 08:00:27:6d:c8:0b MAC dest &#x3D; 08:00:27:9b:fa:c9 proto &#x3D; 0x0800 IP SRC&#x3D;192.168.12.192 IP DST&#x3D;8.8.8.8, IP tos&#x3D;0x00, IP proto&#x3D;17 SPT&#x3D;36289 DPT&#x3D;53</span><br><span class="line">TRACE: eb:nat:PREROUTING IN&#x3D;enp0s8 OUT&#x3D; MAC source &#x3D; 08:00:27:6d:c8:0b MAC dest &#x3D; 08:00:27:9b:fa:c9 proto &#x3D; 0x0800 IP SRC&#x3D;192.168.12.192 IP DST&#x3D;8.8.8.8, IP tos&#x3D;0x00, IP proto&#x3D;17 SPT&#x3D;36289 DPT&#x3D;53</span><br><span class="line">TRACE: eb:filter:INPUT IN&#x3D;enp0s8 OUT&#x3D; MAC source &#x3D; 08:00:27:6d:c8:0b MAC dest &#x3D; 08:00:27:9b:fa:c9 proto &#x3D; 0x0800 IP SRC&#x3D;192.168.12.192 IP DST&#x3D;8.8.8.8, IP tos&#x3D;0x00, IP proto&#x3D;17 SPT&#x3D;36289 DPT&#x3D;53</span><br><span class="line">** SUSPECT raw PREROUTING**IN&#x3D;br0 OUT&#x3D; MAC&#x3D;08:00:27:9b:fa:c9:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;24626 PROTO&#x3D;UDP SPT&#x3D;36289 DPT&#x3D;53 LEN&#x3D;46</span><br><span class="line">** SUSPECT mangle PREROUTING*IN&#x3D;br0 OUT&#x3D; MAC&#x3D;08:00:27:9b:fa:c9:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;24626 PROTO&#x3D;UDP SPT&#x3D;36289 DPT&#x3D;53 LEN&#x3D;46</span><br><span class="line">** SUSPECT nat PREROUTING**IN&#x3D;br0 OUT&#x3D; MAC&#x3D;08:00:27:9b:fa:c9:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;24626 PROTO&#x3D;UDP SPT&#x3D;36289 DPT&#x3D;53 LEN&#x3D;46 MARK&#x3D;0x162</span><br><span class="line">** SUSPECT mangle INPUT**IN&#x3D;br0 OUT&#x3D; MAC&#x3D;08:00:27:9b:fa:c9:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;24626 PROTO&#x3D;UDP SPT&#x3D;36289 DPT&#x3D;53 LEN&#x3D;46 MARK&#x3D;0x162</span><br><span class="line">** SUSPECT filter INPUT**IN&#x3D;br0 OUT&#x3D; MAC&#x3D;08:00:27:9b:fa:c9:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;24626 PROTO&#x3D;UDP SPT&#x3D;36289 DPT&#x3D;53 LEN&#x3D;46 MARK&#x3D;0x162</span><br><span class="line">** SUSPECT nat INPUT**IN&#x3D;br0 OUT&#x3D; MAC&#x3D;08:00:27:9b:fa:c9:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;24626 PROTO&#x3D;UDP SPT&#x3D;36289 DPT&#x3D;53 LEN&#x3D;46 MARK&#x3D;0x162</span><br><span class="line">** SUSPECT raw OUTPUT**IN&#x3D; OUT&#x3D;enp0s3 SRC&#x3D;10.0.2.15 DST&#x3D;10.91.0.1 LEN&#x3D;57 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;56764 DF PROTO&#x3D;UDP SPT&#x3D;45711 DPT&#x3D;53 LEN&#x3D;37</span><br><span class="line">** SUSPECT raw OUTPUT**IN&#x3D; OUT&#x3D;enp0s3 SRC&#x3D;10.0.2.15 DST&#x3D;10.91.0.1 LEN&#x3D;57 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;56765 DF PROTO&#x3D;UDP SPT&#x3D;59060 DPT&#x3D;53 LEN&#x3D;37</span><br><span class="line">** SUSPECT raw PREROUTING**IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;114 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;1722 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;45711 LEN&#x3D;94</span><br><span class="line">** SUSPECT mangle PREROUTING*IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;114 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;1722 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;45711 LEN&#x3D;94</span><br><span class="line">** SUSPECT mangle INPUT**IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;114 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;1722 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;45711 LEN&#x3D;94</span><br><span class="line">** SUSPECT filter INPUT**IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;114 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;1722 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;45711 LEN&#x3D;94</span><br><span class="line">** SUSPECT raw PREROUTING**IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;73 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;1723 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;59060 LEN&#x3D;53</span><br><span class="line">** SUSPECT mangle PREROUTING*IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;73 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;1723 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;59060 LEN&#x3D;53</span><br><span class="line">** SUSPECT mangle INPUT**IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;73 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;1723 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;59060 LEN&#x3D;53</span><br><span class="line">** SUSPECT filter INPUT**IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;73 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;1723 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;59060 LEN&#x3D;53</span><br><span class="line">** SUSPECT raw OUTPUT**IN&#x3D; OUT&#x3D;br0 SRC&#x3D;8.8.8.8 DST&#x3D;192.168.12.192 LEN&#x3D;98 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;40027 DF PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;36289 LEN&#x3D;78</span><br><span class="line">TRACE: eb:nat:OUTPUT IN&#x3D; OUT&#x3D;enp0s8 MAC source &#x3D; 08:00:27:9b:fa:c9 MAC dest &#x3D; 08:00:27:6d:c8:0b proto &#x3D; 0x0800 IP SRC&#x3D;8.8.8.8 IP DST&#x3D;192.168.12.192, IP tos&#x3D;0x00, IP proto&#x3D;17 SPT&#x3D;53 DPT&#x3D;36289</span><br><span class="line">TRACE: eb:filter:OUTPUT IN&#x3D; OUT&#x3D;enp0s8 MAC source &#x3D; 08:00:27:9b:fa:c9 MAC dest &#x3D; 08:00:27:6d:c8:0b proto &#x3D; 0x0800 IP SRC&#x3D;8.8.8.8 IP DST&#x3D;192.168.12.192, IP tos&#x3D;0x00, IP proto&#x3D;17 SPT&#x3D;53 DPT&#x3D;36289</span><br><span class="line">TRACE: eb:nat:POSTROUTING IN&#x3D; OUT&#x3D;enp0s8 MAC source &#x3D; 08:00:27:9b:fa:c9 MAC dest &#x3D; 08:00:27:6d:c8:0b proto &#x3D; 0x0800 IP SRC&#x3D;8.8.8.8 IP DST&#x3D;192.168.12.192, IP tos&#x3D;0x00, IP proto&#x3D;17 SPT&#x3D;53 DPT&#x3D;36289</span><br></pre></td></tr></table></figure>
<p>可以看到包先过了ebtables规则, 然后转入了iptables规则, 也就是包按层级从下到上. 此时的tproxy是正常工作的, 可能你会感到疑惑, 为什么本机向10.91.0.1发送了UDP. 其实是因为我使用了VPN, 所以这是在解析VPN服务器的域名, UDP的转发走的是VPN的TCP通道.<br>接着我加载了br_netfilter, 观察日志:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">TRACE: eb:broute:BROUTING IN&#x3D;enp0s8 OUT&#x3D; MAC source &#x3D; 08:00:27:6d:c8:0b MAC dest &#x3D; 08:00:27:9b:fa:c9 proto &#x3D; 0x0800 IP SRC&#x3D;192.168.12.192 IP DST&#x3D;8.8.8.8, IP tos&#x3D;0x00, IP proto&#x3D;17 SPT&#x3D;36003 DPT&#x3D;53</span><br><span class="line">TRACE: eb:nat:PREROUTING IN&#x3D;enp0s8 OUT&#x3D; MAC source &#x3D; 08:00:27:6d:c8:0b MAC dest &#x3D; 08:00:27:9b:fa:c9 proto &#x3D; 0x0800 IP SRC&#x3D;192.168.12.192 IP DST&#x3D;8.8.8.8, IP tos&#x3D;0x00, IP proto&#x3D;17 SPT&#x3D;36003 DPT&#x3D;53</span><br><span class="line">** SUSPECT raw PREROUTING**IN&#x3D;br0 OUT&#x3D; PHYSIN&#x3D;enp0s8 MAC&#x3D;08:00:27:9b:fa:c9:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;35740 PROTO&#x3D;UDP SPT&#x3D;36003 DPT&#x3D;53 LEN&#x3D;46</span><br><span class="line">** SUSPECT mangle PREROUTING*IN&#x3D;br0 OUT&#x3D; PHYSIN&#x3D;enp0s8 MAC&#x3D;08:00:27:9b:fa:c9:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;35740 PROTO&#x3D;UDP SPT&#x3D;36003 DPT&#x3D;53 LEN&#x3D;46</span><br><span class="line">** SUSPECT nat PREROUTING**IN&#x3D;br0 OUT&#x3D; PHYSIN&#x3D;enp0s8 MAC&#x3D;08:00:27:9b:fa:c9:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;35740 PROTO&#x3D;UDP SPT&#x3D;36003 DPT&#x3D;53 LEN&#x3D;46 MARK&#x3D;0x162</span><br><span class="line">TRACE: eb:filter:INPUT IN&#x3D;enp0s8 OUT&#x3D; MAC source &#x3D; 08:00:27:6d:c8:0b MAC dest &#x3D; 08:00:27:9b:fa:c9 proto &#x3D; 0x0800 IP SRC&#x3D;192.168.12.192 IP DST&#x3D;8.8.8.8, IP tos&#x3D;0x00, IP proto&#x3D;17 SPT&#x3D;36003 DPT&#x3D;53</span><br><span class="line">** SUSPECT mangle INPUT**IN&#x3D;br0 OUT&#x3D; PHYSIN&#x3D;enp0s8 MAC&#x3D;08:00:27:9b:fa:c9:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;35740 PROTO&#x3D;UDP SPT&#x3D;36003 DPT&#x3D;53 LEN&#x3D;46 MARK&#x3D;0x162</span><br><span class="line">** SUSPECT filter INPUT**IN&#x3D;br0 OUT&#x3D; PHYSIN&#x3D;enp0s8 MAC&#x3D;08:00:27:9b:fa:c9:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;35740 PROTO&#x3D;UDP SPT&#x3D;36003 DPT&#x3D;53 LEN&#x3D;46 MARK&#x3D;0x162</span><br><span class="line">** SUSPECT nat INPUT**IN&#x3D;br0 OUT&#x3D; PHYSIN&#x3D;enp0s8 MAC&#x3D;08:00:27:9b:fa:c9:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;35740 PROTO&#x3D;UDP SPT&#x3D;36003 DPT&#x3D;53 LEN&#x3D;46 MARK&#x3D;0x162</span><br></pre></td></tr></table></figure>
<p>这是什么情况??? 数据包在两个层级之间跳来跳去??? 我开始搜索相关资料, 原来这是br_netfilter提供的透明防火墙功能, 使得三层规则可以作用在二层上. 因为桥接的端口之间发送包是被网桥直接转走的, 不会走到本机的iptables中, 而br_netfilter使得ebtables主动调用iptables规则, 这样所有的包都能接受过滤.<br>谜底揭开了, 我看到的日志显示包已经到了filter表的INPUT, 可实际上它还没有过IP层路由选择, 它此时在二层ebtables的filter表中, 只不过它主动的调用了iptables. 也就是说这个包没有通过路由进入本地协议栈, 它被丢弃或者转走了. 大概是因为iptables打上的fwmark, 在ebtables中丢失了, 导致进行路由选择时无法命中我们添加的路由规则.<br>于是我看阅读ebtables的文档, 文档中说道, 在broute表中将流量DROP, 会使得包进入Network Layer处理, 这样就是图中broute有个箭头指到上层的含义.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ebtables-legacy -t broute -A BROUTING -i enp0s8 -p ipv4 --ip-proto udp -j redirect --redirect-target DROP</span><br></pre></td></tr></table></figure>
<p>我执行上面的命令后, 再执行查询操作:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">TRACE: eb:broute:BROUTING IN&#x3D;enp0s8 OUT&#x3D; MAC source &#x3D; 08:00:27:6d:c8:0b MAC dest &#x3D; 08:00:27:9b:fa:c9 proto &#x3D; 0x0800 IP SRC&#x3D;192.168.12.192 IP DST&#x3D;8.8.8.8, IP tos&#x3D;0x00, IP proto&#x3D;17 SPT&#x3D;47382 DPT&#x3D;53</span><br><span class="line">** SUSPECT raw PREROUTING**IN&#x3D;enp0s8 OUT&#x3D; MAC&#x3D;08:00:27:ae:7d:59:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;25647 PROTO&#x3D;UDP SPT&#x3D;47382 DPT&#x3D;53 LEN&#x3D;46</span><br><span class="line">** SUSPECT mangle PREROUTING*IN&#x3D;enp0s8 OUT&#x3D; MAC&#x3D;08:00:27:ae:7d:59:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;25647 PROTO&#x3D;UDP SPT&#x3D;47382 DPT&#x3D;53 LEN&#x3D;46</span><br><span class="line">** SUSPECT nat PREROUTING**IN&#x3D;enp0s8 OUT&#x3D; MAC&#x3D;08:00:27:ae:7d:59:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;25647 PROTO&#x3D;UDP SPT&#x3D;47382 DPT&#x3D;53 LEN&#x3D;46 MARK&#x3D;0x162</span><br><span class="line">** SUSPECT mangle INPUT**IN&#x3D;enp0s8 OUT&#x3D; MAC&#x3D;08:00:27:ae:7d:59:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;25647 PROTO&#x3D;UDP SPT&#x3D;47382 DPT&#x3D;53 LEN&#x3D;46 MARK&#x3D;0x162</span><br><span class="line">** SUSPECT filter INPUT**IN&#x3D;enp0s8 OUT&#x3D; MAC&#x3D;08:00:27:ae:7d:59:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;25647 PROTO&#x3D;UDP SPT&#x3D;47382 DPT&#x3D;53 LEN&#x3D;46 MARK&#x3D;0x162</span><br><span class="line">** SUSPECT nat INPUT**IN&#x3D;enp0s8 OUT&#x3D; MAC&#x3D;08:00:27:ae:7d:59:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;8.8.8.8 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;25647 PROTO&#x3D;UDP SPT&#x3D;47382 DPT&#x3D;53 LEN&#x3D;46 MARK&#x3D;0x162</span><br><span class="line">** SUSPECT raw OUTPUT**IN&#x3D; OUT&#x3D;enp0s3 SRC&#x3D;10.0.2.15 DST&#x3D;10.91.0.1 LEN&#x3D;57 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;40282 DF PROTO&#x3D;UDP SPT&#x3D;54985 DPT&#x3D;53 LEN&#x3D;37</span><br><span class="line">** SUSPECT raw OUTPUT**IN&#x3D; OUT&#x3D;enp0s3 SRC&#x3D;10.0.2.15 DST&#x3D;10.91.0.1 LEN&#x3D;57 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;40283 DF PROTO&#x3D;UDP SPT&#x3D;37997 DPT&#x3D;53 LEN&#x3D;37</span><br><span class="line">** SUSPECT raw PREROUTING**IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;73 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;4012 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;37997 LEN&#x3D;53</span><br><span class="line">** SUSPECT mangle PREROUTING*IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;73 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;4012 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;37997 LEN&#x3D;53</span><br><span class="line">** SUSPECT mangle INPUT**IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;73 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;4012 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;37997 LEN&#x3D;53</span><br><span class="line">** SUSPECT filter INPUT**IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;73 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;4012 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;37997 LEN&#x3D;53</span><br><span class="line">** SUSPECT raw PREROUTING**IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;114 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;4018 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;54985 LEN&#x3D;94</span><br><span class="line">** SUSPECT mangle PREROUTING*IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;114 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;4018 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;54985 LEN&#x3D;94</span><br><span class="line">** SUSPECT mangle INPUT**IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;114 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;4018 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;54985 LEN&#x3D;94</span><br><span class="line">** SUSPECT filter INPUT**IN&#x3D;enp0s3 OUT&#x3D; MAC&#x3D;08:00:27:4f:1e:2b:52:54:00:12:35:02:08:00 SRC&#x3D;10.91.0.1 DST&#x3D;10.0.2.15 LEN&#x3D;114 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;4018 PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;54985 LEN&#x3D;94</span><br><span class="line">** SUSPECT raw OUTPUT**IN&#x3D; OUT&#x3D;br0 SRC&#x3D;8.8.8.8 DST&#x3D;192.168.12.192 LEN&#x3D;98 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;26403 DF PROTO&#x3D;UDP SPT&#x3D;53 DPT&#x3D;47382 LEN&#x3D;78</span><br><span class="line">TRACE: eb:nat:OUTPUT IN&#x3D; OUT&#x3D;enp0s8 MAC source &#x3D; 08:00:27:9b:fa:c9 MAC dest &#x3D; 08:00:27:6d:c8:0b proto &#x3D; 0x0800 IP SRC&#x3D;8.8.8.8 IP DST&#x3D;192.168.12.192, IP tos&#x3D;0x00, IP proto&#x3D;17 SPT&#x3D;53 DPT&#x3D;47382</span><br><span class="line">TRACE: eb:filter:OUTPUT IN&#x3D; OUT&#x3D;enp0s8 MAC source &#x3D; 08:00:27:9b:fa:c9 MAC dest &#x3D; 08:00:27:6d:c8:0b proto &#x3D; 0x0800 IP SRC&#x3D;8.8.8.8 IP DST&#x3D;192.168.12.192, IP tos&#x3D;0x00, IP proto&#x3D;17 SPT&#x3D;53 DPT&#x3D;47382</span><br><span class="line">TRACE: eb:nat:POSTROUTING IN&#x3D; OUT&#x3D;enp0s8 MAC source &#x3D; 08:00:27:9b:fa:c9 MAC dest &#x3D; 08:00:27:6d:c8:0b proto &#x3D; 0x0800 IP SRC&#x3D;8.8.8.8 IP DST&#x3D;192.168.12.192, IP tos&#x3D;0x00, IP proto&#x3D;17 SPT&#x3D;53 DPT&#x3D;47382</span><br></pre></td></tr></table></figure>
<p>可以看到包的确被重定向到了Network Layer, tproxy也正常工作了.</p>
<h2 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h2><p>正当我以为一切都结束了的时候, 我打开了斗鱼直播, 可浏览器却显示网络异常, 我又上不了网了. 我在终端进行ping测试, IP可以ping通而域名不行, 这样看来是DNS的问题.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig baidu.com @192.168.12.1</span><br></pre></td></tr></table></figure>
<p>命令卡住了, 难道发往本地的包重定向到Network Layer就被拒收了? 我又开始观察ebtables/iptables的日志输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TRACE: eb:broute:BROUTING IN&#x3D;enp0s8 OUT&#x3D; MAC source &#x3D; 08:00:27:6d:c8:0b MAC dest &#x3D; 08:00:27:9b:fa:c9 proto &#x3D; 0x0800 IP SRC&#x3D;192.168.12.192 IP DST&#x3D;192.168.12.1, IP tos&#x3D;0x00, IP proto&#x3D;17 SPT&#x3D;34741 DPT&#x3D;53</span><br><span class="line">** SUSPECT raw PREROUTING**IN&#x3D;enp0s8 OUT&#x3D; MAC&#x3D;08:00:27:ae:7d:59:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;192.168.12.1 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;7347 PROTO&#x3D;UDP SPT&#x3D;34741 DPT&#x3D;53 LEN&#x3D;46</span><br><span class="line">** SUSPECT mangle PREROUTING*IN&#x3D;enp0s8 OUT&#x3D; MAC&#x3D;08:00:27:ae:7d:59:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;192.168.12.1 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;7347 PROTO&#x3D;UDP SPT&#x3D;34741 DPT&#x3D;53 LEN&#x3D;46</span><br><span class="line">** SUSPECT nat PREROUTING**IN&#x3D;enp0s8 OUT&#x3D; MAC&#x3D;08:00:27:ae:7d:59:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;192.168.12.1 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;7347 PROTO&#x3D;UDP SPT&#x3D;34741 DPT&#x3D;53 LEN&#x3D;46</span><br><span class="line">** SUSPECT mangle INPUT**IN&#x3D;enp0s8 OUT&#x3D; MAC&#x3D;08:00:27:ae:7d:59:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;192.168.12.1 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;7347 PROTO&#x3D;UDP SPT&#x3D;34741 DPT&#x3D;53 LEN&#x3D;46</span><br><span class="line">** SUSPECT filter INPUT**IN&#x3D;enp0s8 OUT&#x3D; MAC&#x3D;08:00:27:ae:7d:59:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;192.168.12.1 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;7347 PROTO&#x3D;UDP SPT&#x3D;34741 DPT&#x3D;53 LEN&#x3D;46</span><br><span class="line">** SUSPECT nat INPUT**IN&#x3D;enp0s8 OUT&#x3D; MAC&#x3D;08:00:27:ae:7d:59:08:00:27:6d:c8:0b:08:00 SRC&#x3D;192.168.12.192 DST&#x3D;192.168.12.1 LEN&#x3D;66 TOS&#x3D;0x00 PREC&#x3D;0x00 TTL&#x3D;64 ID&#x3D;7347 PROTO&#x3D;UDP SPT&#x3D;34741 DPT&#x3D;53 LEN&#x3D;46</span><br></pre></td></tr></table></figure>
<p>数据包已经进入了INPUT, 这次的确是进入了本地协议栈, 但是需要注意数据包的IN网卡已经从桥接网卡bro变成了真实网卡端口enp0s8. 难道是因为这个改变, 而被协议栈拒收? 还是因为dnsmasq没有bind该网卡?<br>我手动使用nc进行测试:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -u -lp 3000</span><br></pre></td></tr></table></figure>
<p>使用nc监听软路由上3000端口, 然后在电脑上执行:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig baidu.com @192.168.12.1 -p 3000</span><br></pre></td></tr></table></figure>
<p>如果数据能被接收, nc会打印出DNS查询报文, 结果令我诧异, nc打印出了报文内容. 那么看来即使IN interface被修改, 数据包依旧能够被正确接收.<br>最后我使用strace追踪dnsmasq的系统调用:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strace /sbin/dnsmasq</span><br></pre></td></tr></table></figure>
<p>执行查询后, 我发现dnsmasq接收到了报文, 只是它似乎获取了网卡名称bro与enp0s8, 应该是它进行了网卡校验, 认为请求不应该由enp0s8流入, 所以没有进行回应.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>为了不影响Docker的正常使用, 我没有将所有Link Layer流量进行重定向, 放行了一些常见内网IP网段.<br>所以我最后的ebtables/iptables配置如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tcp</span></span><br><span class="line">iptables -t nat -N CLASH</span><br><span class="line">iptables -t nat -A CLASH -d 127.0.0.0/8 -j RETURN</span><br><span class="line">iptables -t nat -A CLASH -d 10.0.0.0/8 -j RETURN</span><br><span class="line">iptables -t nat -A CLASH -d 169.254.0.0/16 -j RETURN</span><br><span class="line">iptables -t nat -A CLASH -d 192.168.0.0/16 -j RETURN</span><br><span class="line">iptables -t nat -A CLASH -d 224.0.0.0/4 -j RETURN</span><br><span class="line">iptables -t nat -A CLASH -d 240.0.0.0/4 -j RETURN</span><br><span class="line">iptables -t nat -A CLASH -d 172.16.0.0/12 -j RETURN</span><br><span class="line">iptables -t nat -A CLASH -d 255.255.255.255 -j RETURN</span><br><span class="line">iptables -t nat -A CLASH -p tcp -j REDIRECT --to-ports 7892</span><br><span class="line">iptables -t nat -A PREROUTING -p tcp -j CLASH</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> udp</span></span><br><span class="line">ip rule add fwmark 0x162 table 0x162</span><br><span class="line">ip route add local 0.0.0.0/0 dev lo table 0x162</span><br><span class="line">iptables -t mangle -N CLASH</span><br><span class="line">iptables -t mangle -A CLASH -d 127.0.0.0/8 -j RETURN</span><br><span class="line">iptables -t mangle -A CLASH -d 10.0.0.0/8 -j RETURN</span><br><span class="line">iptables -t mangle -A CLASH -d 169.254.0.0/16 -j RETURN</span><br><span class="line">iptables -t mangle -A CLASH -d 192.168.0.0/16 -j RETURN</span><br><span class="line">iptables -t mangle -A CLASH -d 224.0.0.0/4 -j RETURN</span><br><span class="line">iptables -t mangle -A CLASH -d 240.0.0.0/4 -j RETURN</span><br><span class="line">iptables -t mangle -A CLASH -d 172.16.0.0/12 -j RETURN</span><br><span class="line">iptables -t mangle -A CLASH -d 255.255.255.255 -j RETURN</span><br><span class="line">iptables -t mangle -A CLASH -p udp -j TPROXY --on-port 7892 --tproxy-mark 0x162</span><br><span class="line">iptables -t mangle -A PREROUTING -p udp -j CLASH</span><br><span class="line"></span><br><span class="line">ebtables-legacy -t broute -A BROUTING -p ipv4 --ip-proto udp --ip-destination 127.0.0.0/8 -j ACCEPT</span><br><span class="line">ebtables-legacy -t broute -A BROUTING -p ipv4 --ip-proto udp --ip-destination 10.0.0.0/8 -j ACCEPT</span><br><span class="line">ebtables-legacy -t broute -A BROUTING -p ipv4 --ip-proto udp --ip-destination 169.254.0.0/16 -j ACCEPT</span><br><span class="line">ebtables-legacy -t broute -A BROUTING -p ipv4 --ip-proto udp --ip-destination 192.168.0.0/16 -j ACCEPT</span><br><span class="line">ebtables-legacy -t broute -A BROUTING -p ipv4 --ip-proto udp --ip-destination 224.0.0.0/4 -j ACCEPT</span><br><span class="line">ebtables-legacy -t broute -A BROUTING -p ipv4 --ip-proto udp --ip-destination 240.0.0.0/4 -j ACCEPT</span><br><span class="line">ebtables-legacy -t broute -A BROUTING -p ipv4 --ip-proto udp --ip-destination 172.16.0.0/12 -j ACCEPT</span><br><span class="line">ebtables-legacy -t broute -A BROUTING -p ipv4 --ip-proto udp --ip-destination 255.255.255.255 -j ACCEPT</span><br><span class="line">ebtables-legacy -t broute -A BROUTING -p ipv4 --ip-proto udp -j redirect --redirect-target DROP</span><br></pre></td></tr></table></figure>
<p>有一点需要注意, ebtables规则不需要”-i name”指定网卡名称, 因为理论上docker容器与个人电脑(连接软路由LAN口)处于同一网络层面. 不管是LAN口网桥还是docker网桥, 都需要适配该规则, 否则UDP透明代理将失败.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hackerl.github.io/2020/09/11/%E8%BD%AF%E8%B7%AF%E7%94%B1%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95%E4%BA%8C/" data-id="clogx15kg000e9tt268ok64sv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/11/02/CPP-%E5%8D%8F%E7%A8%8B%E8%B8%A9%E5%9D%91/">C++ 协程踩坑</a>
          </li>
        
          <li>
            <a href="/2023/05/24/%E6%88%91%E7%9A%84%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84/">我的家庭网络架构</a>
          </li>
        
          <li>
            <a href="/2022/10/21/Nokia-7P-%E5%88%B7%E6%9C%BA/">Nokia 7P 刷机</a>
          </li>
        
          <li>
            <a href="/2022/02/28/Elkeid-Golang-RASP/">Elkeid Golang RASP</a>
          </li>
        
          <li>
            <a href="/2021/02/13/Node-js%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5/">Node.js进程注入</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 hackerl<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>